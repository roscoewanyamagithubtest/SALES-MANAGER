<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales System ‚Äî All-in-One (with Auth & Users)</title>
  <style>
    :root{
      --bg1:#0f2027; --bg2:#203a43; --bg3:#2c5364;
      --panel:#1a1f29; --card:#242b38;
      --accent:#06b6d4; --accent2:#7c3aed;
      --radius:12px; --muted:#94a3b8;
      font-family: Inter, ui-sans-serif, system-ui;
      color-scheme: dark;
    }
    *{box-sizing:border-box;}
    body{margin:0;min-height:100vh;display:flex;background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));color:#e6eef8;}
    .app{flex:1;display:flex;}
    .sidebar{width:240px;background:var(--panel);padding:20px;display:flex;flex-direction:column;}
    .logo{display:flex;align-items:center;gap:10px;margin-bottom:20px;}
    .logo h1{font-size:1.1em;margin:0;}
    .nav-item{padding:10px;border-radius:var(--radius);cursor:pointer;display:flex;align-items:center;gap:10px;}
    .nav-item:hover,.nav-item.active{background:var(--accent);color:#fff;}
    .main{flex:1;padding:20px;overflow:auto;}
    .card{background:var(--card);padding:20px;border-radius:var(--radius);margin-bottom:20px;box-shadow:0 4px 8px rgba(0,0,0,0.2);}
    .table{width:100%;border-collapse:collapse;}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left;}
    .btn{padding:6px 12px;border:none;border-radius:var(--radius);cursor:pointer;}
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-danger{background:#ef4444;color:#fff;}
    .btn-secondary{background:#64748b;color:#fff;}
    .muted{color:var(--muted);font-size:0.9em}
    .small{font-size:0.9em;padding:4px 8px}
    .unsaved{background-color:rgba(255,215,0,0.1);border-left:4px solid #ffd700;}
    .saved{background-color:rgba(34,197,94,0.1);border-left:4px solid #22c55e;}
    /* Modals */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;}
    .modal .modal-box{background:#fff;color:#000;padding:20px;width:600px;max-height:90%;overflow:auto;border-radius:var(--radius);}
    .modal input,.modal select,.modal textarea{width:100%;padding:8px;margin:5px 0;}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
    .right{margin-left:auto;display:flex;gap:10px;align-items:center;}
    .badge{background:rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;}
    .disabled{opacity:0.5;pointer-events:none;}
    label.inline{display:inline-block;margin-right:8px;}
    .paging{display:flex;gap:6px;align-items:center;}
    @media(max-width:768px){
      .sidebar{width:70px;padding:10px;}
      .sidebar .logo h1,.sidebar .nav-item div{display:none;}
      .table{font-size:0.85em;}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo"><div class="mark">üìä</div><h1>SALES SYSTEM</h1></div>
    <nav id="navList">
      <div class="nav-item active" data-view="dashboard">üè† Dashboard</div>
      <div class="nav-item" data-view="sales">üßæ Sales</div>
      <div class="nav-item" data-view="inventory">üì¶ Inventory</div>
      <div class="nav-item" data-view="expenses">üí∏ Expenses</div>
      <div class="nav-item" data-view="employees">üë• Employees</div>
      <div class="nav-item" data-view="suppliers">üöö Suppliers</div>
      <div class="nav-item" data-view="deposits">üè¶ Deposits</div>
      <div class="nav-item" data-view="records">üìÅ Records</div>
      <div class="nav-item" data-view="settings">‚öôÔ∏è Settings</div>
    </nav>
    <div style="margin-top:auto;margin-left:4px;">
      <div id="currentUserDisplay" class="muted"></div>
      <div style="margin-top:8px;"><button class="btn small" onclick="logout()">Logout</button></div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="badge" id="systemStatus">Offline</div>
      <div class="muted">Client-side demo ‚Äî data stored in localStorage</div>
      <div class="right">
        <div id="quickUserActions"></div>
      </div>
    </div>

    <!-- Dashboard -->
    <section data-view="dashboard" class="view card">
      <h2>Dashboard</h2>
      <p>Welcome to your Sales System overview.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:20px;">
        <div class="card" style="text-align:center;">
          <h3>Total Sales</h3>
          <div style="font-size:2em;color:var(--accent);" id="dashTotalSales">UGX 0</div>
        </div>
        <div class="card" style="text-align:center;">
          <h3>Total Expenses</h3>
          <div style="font-size:2em;color:#ef4444;" id="dashTotalExpenses">UGX 0</div>
        </div>
        <div class="card" style="text-align:center;">
          <h3>Inventory Items</h3>
          <div style="font-size:2em;color:#22c55e;" id="dashInventoryCount">0</div>
        </div>
        <div class="card" style="text-align:center;">
          <h3>Total Deposits</h3>
          <div style="font-size:2em;color:#f59e0b;" id="dashTotalDeposits">UGX 0</div>
        </div>
      </div>
    </section>

    <!-- Sales -->
    <section data-view="sales" class="view card" style="display:none">
      <h2>Sales 
        <button class="btn btn-primary" id="newSaleBtn" onclick="openSaleModal()">+ New Sale</button>
        <button class="btn btn-secondary" onclick="printSales()">üñ®Ô∏è Print All Sales</button>
      </h2>
      <table class="table" id="salesTable">
        <thead><tr><th>Date</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Inventory -->
    <section data-view="inventory" class="view card" style="display:none">
      <h2>Inventory 
        <button class="btn btn-primary" onclick="openInventoryModal()">+ Add Item</button>
        <button class="btn btn-secondary" onclick="printInventory()">üñ®Ô∏è Print</button>
      </h2>
      <table class="table" id="inventoryTable">
        <thead>
          <tr><th>Item</th><th>Category</th><th>Supplier</th><th>Qty</th><th>Cost</th><th>Reorder</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Expenses -->
    <section data-view="expenses" class="view card" style="display:none">
      <h2>Expenses 
        <button class="btn btn-primary" onclick="openExpenseModal()">+ Add Expense</button>
        <button class="btn btn-secondary" onclick="printExpenses()">üñ®Ô∏è Print</button>
      </h2>
      <div style="margin:10px 0;">
        <label>From: <input type="date" id="expenseFrom"></label>
        <label>To: <input type="date" id="expenseTo"></label>
        <button class="btn btn-secondary" onclick="searchExpenses()">üîç Search</button>
        <button class="btn btn-secondary" onclick="renderExpenses()">Reset</button>
      </div>
      <table class="table" id="expensesTable">
        <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="6" id="expenseTotal" style="text-align:right;font-weight:bold;"></td></tr>
        </tfoot>
      </table>
    </section>

    <!-- Employees -->
    <section data-view="employees" class="view card" style="display:none">
      <h2>Employees 
        <button class="btn btn-primary" onclick="openEmployeeModal()">+ Add Employee</button>
        <button class="btn btn-secondary" onclick="printEmployees()">üñ®Ô∏è Print</button>
      </h2>
      <table class="table" id="employeesTable">
        <thead>
          <tr><th>Name</th><th>Position</th><th>Email</th><th>Phone</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Suppliers -->
    <section data-view="suppliers" class="view card" style="display:none">
      <h2>Suppliers 
        <button class="btn btn-primary" onclick="openSupplierModal()">+ Add Supplier</button>
        <button class="btn btn-secondary" onclick="printSuppliers()">üñ®Ô∏è Print</button>
      </h2>
      <table class="table" id="suppliersTable">
        <thead>
          <tr><th>Name</th><th>Contact</th><th>Email</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Deposits -->
    <section data-view="deposits" class="view card" style="display:none">
      <h2>Deposits 
        <button class="btn btn-primary" onclick="openDepositModal()">+ Add Deposit</button>
        <button class="btn btn-secondary" onclick="printDeposits()">üñ®Ô∏è Print</button>
      </h2>
      <table class="table" id="depositsTable">
        <thead>
          <tr><th>Date</th><th>Client</th><th>Item Deposited On</th><th>Initial Amount</th><th>Remaining Balance</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Records -->
    <section data-view="records" class="view card" style="display:none">
      <h2>Company Records</h2>

      <div style="margin:10px 0;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label>From: <input type="date" id="recordsFrom"></label>
        <label>To: <input type="date" id="recordsTo"></label>
        <label>Type:
          <select id="recordsType">
            <option value="">All</option>
            <option>Sale</option>
            <option>Expense</option>
            <option>Inventory</option>
            <option>Deposit</option>
          </select>
        </label>
        <label>Text: <input id="recordsText" placeholder="search details/ref/meta" /></label>
        <button class="btn btn-secondary" onclick="searchRecords()">üîç Search Records</button>
        <button class="btn btn-secondary" onclick="renderRecords()">Reset</button>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <label class="inline">Page size:
            <select id="recordsPageSize" onchange="renderRecords()"><option>10</option><option>25</option><option>50</option></select>
          </label>
          <button class="btn btn-secondary" onclick="printRecords()">üñ®Ô∏è Print Records</button>
        </div>
      </div>

      <table class="table" id="recordsTable">
        <thead>
          <tr><th>Type</th><th>Date</th><th>Reference</th><th>Details</th><th>Amount / Qty</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="6" id="recordsSummary" style="text-align:right;font-weight:bold;"></td></tr>
        </tfoot>
      </table>

      <div style="margin-top:8px;display:flex;justify-content:flex-end;align-items:center;gap:8px;">
        <div class="paging">
          <button class="btn small" onclick="recordsPrev()">Prev</button>
          <span id="recordsPagerInfo" class="muted">Page 1 / 1</span>
          <button class="btn small" onclick="recordsNext()">Next</button>
        </div>
        <div>
          <label>Go to: <input id="recordsGoto" type="number" style="width:70px" /></label>
          <button class="btn small" onclick="recordsJump()">Go</button>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section data-view="settings" class="view card" style="display:none">
      <h2>Settings</h2>
      <div id="settingsAdminArea"></div>
      <hr/>
      <h3>Company Details (printed on receipts)</h3>
      <form id="companyForm">
        <label>Company Name</label><input id="companyName" />
        <label>Location</label><input id="companyLocation" />
        <label>P.O. Box</label><input id="companyBox" />
        <label>Telephone</label><input id="companyTel" />
        <label>Email</label><input id="companyEmail" />
        <div style="text-align:right;margin-top:8px;"><button class="btn btn-primary">Save Company</button></div>
      </form>
    </section>
  </main>
</div>

<!-- LOGIN Modal -->
<div id="loginModal" class="modal" style="display:flex">
  <div class="modal-box">
    <h2>Login</h2>
    <form id="loginForm">
      <label>Username</label><input id="loginUsername" required/>
      <label>Password</label><input id="loginPassword" type="password" required/>
      <div style="margin-top:10px;text-align:right;">
        <button type="submit" class="btn btn-primary">Login</button>
      </div>
    </form>
    <p class="muted" style="margin-top:8px">Default admin: <strong>admin</strong> / <strong>admin123</strong>. (client-side demo)</p>
  </div>
</div>

<!-- User Management Modal (admin only) -->
<div id="userModal" class="modal">
  <div class="modal-box">
    <h2>Manage Users</h2>
    <form id="userForm">
      <input type="hidden" id="userId" />
      <label>Username</label><input id="userName" required />
      <label>Password</label><input id="userPass" type="password" />
      <label>Role</label>
      <select id="userRole">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
      <label><input type="checkbox" id="userCanViewRecords" /> Allow access to Records</label>
      <label><input type="checkbox" id="userCanCreateSales" checked /> Allow create Sales</label>
      <div style="margin-top:10px;text-align:right;">
        <button type="submit" class="btn btn-primary">Save User</button>
        <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
      </div>
    </form>
    <hr/>
    <h3>Existing users</h3>
    <div id="usersList"></div>
  </div>
</div>

<!-- Sale Modal -->
<div id="saleModal" class="modal">
  <div class="modal-box">
    <h2>New Sale</h2>
    <form id="saleForm">
      <input type="hidden" id="saleId"/>
      <label>Customer</label><input id="customerName" required/>
      <label>Phone Number</label><input id="customerContact" required/>
      <div style="display:flex;gap:8px;align-items:center;margin:8px 0;">
        <label class="inline">Sale discount (flat):</label><input id="saleDiscount" type="number" value="0" style="width:120px"/>
        <label class="inline">Sale discount (%) :</label><input id="saleDiscountPct" type="number" value="0" style="width:80px"/>
      </div>
      <div id="saleItems"></div>
      <button type="button" class="btn btn-secondary" onclick="addSaleItem()">+ Add Product</button>
      <div style="margin-top:10px;text-align:right;">
        <strong id="saleTotalDisplay">Total: UGX 0</strong>
      </div>
      <div style="margin-top:10px;text-align:right;">
        <button type="submit" class="btn btn-primary">Save Sale</button>
        <button type="button" class="btn btn-secondary" onclick="closeSaleModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Inventory Modal -->
<div id="inventoryModal" class="modal">
  <div class="modal-box">
    <h2>Add / Edit Item</h2>
    <form id="inventoryForm">
      <input type="hidden" id="itemId"/>
      <label>Item</label><input id="itemName" required/>
      <label>Category</label><input id="itemCategory"/>
      <label>Supplier</label><input id="itemSupplier"/>
      <label>Quantity</label><input id="itemQty" type="number" required/>
      <label>Cost (per unit)</label><input id="itemCost" type="number" required/>
      <label>Reorder Level</label><input id="itemReorder" type="number" value="5"/>
      <div style="text-align:right;margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Expense Modal -->
<div id="expenseModal" class="modal">
  <div class="modal-box">
    <h2>Add Expense</h2>
    <form id="expenseForm">
      <input type="hidden" id="expenseId"/>
      <label>Date</label><input type="date" id="expenseDate" required/>
      <label>Category</label><input id="expenseCategory" required/>
      <label>Description</label><input id="expenseDesc" required/>
      <label>Amount</label><input type="number" id="expenseAmount" required/>
      <div style="text-align:right;margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeExpenseModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Employee Modal -->
<div id="employeeModal" class="modal">
  <div class="modal-box">
    <h2>Add / Edit Employee</h2>
    <form id="employeeForm">
      <input type="hidden" id="employeeId"/>
      <label>Name</label><input id="employeeName" required/>
      <label>Position</label><input id="employeePosition"/>
      <label>Email</label><input id="employeeEmail"/>
      <label>Phone</label><input id="employeePhone"/>
      <div style="text-align:right;margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Supplier Modal -->
<div id="supplierModal" class="modal">
  <div class="modal-box">
    <h2>Add / Edit Supplier</h2>
    <form id="supplierForm">
      <input type="hidden" id="supplierId"/>
      <label>Name</label><input id="supplierName" required/>
      <label>Contact</label><input id="supplierContact"/>
      <label>Email</label><input id="supplierEmail"/>
      <div style="text-align:right;margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeSupplierModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Deposit Modal -->
<div id="depositModal" class="modal">
  <div class="modal-box">
    <h2>Add Deposit</h2>
    <form id="depositForm">
      <input type="hidden" id="depositId"/>
      <label>Date</label><input type="date" id="depositDate" required/>
      <label>Client</label><input id="depositClient" required/>
      <label>Item Deposited On</label><input id="depositItem" required placeholder="What item/service is this deposit for?"/>
      <label>Initial Amount</label><input type="number" id="depositAmount" required/>
      <label>Amount Used (optional)</label><input type="number" id="depositUsed" value="0" placeholder="Amount used from deposit"/>
      <div style="text-align:right;margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeDepositModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ===========================
   STORAGE & INITIAL STATE
   =========================== */
const STORAGE_KEY = "sales_system_data_v3";
const fmt = n => "UGX " + Number(n||0).toLocaleString();
const idf = () => Math.random().toString(36).substr(2,9);

let state = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
if(!state.sales) state.sales=[];
if(!state.inventory) state.inventory=[];
if(!state.expenses) state.expenses=[];
if(!state.employees) state.employees=[];
if(!state.suppliers) state.suppliers=[];
if(!state.deposits) state.deposits=[];
if(!state.users) {
  // default admin user (client-side demo)
  state.users = [
    {id: idf(), username: 'admin', password: 'admin123', role:'admin', canViewRecords:true, canCreateSales:true}
  ];
}
if(!state.meta) state.meta={currentUserId:null};
if(!state.company) state.company={name:'', location:'', box:'', tel:'', email:''};

// helper to persist
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); updateUIForAuth(); updateDashboard(); }

// currently logged in user (object or null)
function currentUser(){ return state.users.find(u=>u.id===state.meta.currentUserId) || null; }

// Company header for all receipts
function companyHeaderHTML(){
  const c = state.company || {};
  return `<div style="text-align:center;margin-bottom:20px;">` +
         `<h2 style="margin:0;padding:0;">${c.name || 'Sales System'}</h2>` +
         `<div>${c.location || ''} ${c.box ? ('P.O. Box ' + c.box) : ''}</div>` +
         `<div>Tel: ${c.tel || ''} ${c.email ? ('| Email: ' + c.email) : ''}</div>` +
         `<hr style="border:1px solid #ccc;"/></div>`;
}

// Update dashboard statistics
function updateDashboard(){
  const totalSales = state.sales.reduce((sum, s) => sum + (s.total || 0), 0);
  const totalExpenses = state.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
  const inventoryCount = state.inventory.length;
  const totalDeposits = state.deposits.reduce((sum, d) => sum + (d.amount || 0), 0);
  
  const dashSales = document.getElementById('dashTotalSales');
  const dashExpenses = document.getElementById('dashTotalExpenses');
  const dashInventory = document.getElementById('dashInventoryCount');
  const dashDeposits = document.getElementById('dashTotalDeposits');
  
  if(dashSales) dashSales.textContent = fmt(totalSales);
  if(dashExpenses) dashExpenses.textContent = fmt(totalExpenses);
  if(dashInventory) dashInventory.textContent = inventoryCount;
  if(dashDeposits) dashDeposits.textContent = fmt(totalDeposits);
}

/* ===========================
   AUTH (CLIENT-SIDE)
   =========================== */
function showLogin(){ document.getElementById('loginModal').style.display='flex'; }
function hideLogin(){ document.getElementById('loginModal').style.display='none'; }
document.getElementById('loginForm').addEventListener('submit', e=>{
  e.preventDefault();
  const u = document.getElementById('loginUsername').value.trim();
  const p = document.getElementById('loginPassword').value;
  const user = state.users.find(x=>x.username === u && x.password === p);
  if(!user){ alert('Invalid credentials'); return; }
  state.meta.currentUserId = user.id; save(); hideLogin();
  renderAll(); alert('Logged in as '+user.username);
});
function logout(){ state.meta.currentUserId = null; save(); showLogin(); renderAll(); }

/* ===========================
   NAVIGATION
   =========================== */
document.querySelectorAll("#navList .nav-item").forEach(nav=>{
  nav.addEventListener("click", ()=>{
    const user = currentUser();
    // restrict records nav
    if(nav.dataset.view === 'records' && (!user || !user.canViewRecords)) { alert('You do not have permission to view Records'); return; }
    document.querySelectorAll("#navList .nav-item").forEach(n=>n.classList.remove("active"));
    nav.classList.add("active");
    const v=nav.dataset.view;
    document.querySelectorAll(".view").forEach(sec=>sec.style.display='none');
    document.querySelector(`.view[data-view='${v}']`).style.display='block';
    renderAll();
  });
});

/* ===========================
   SALES (with save status tracking)
   =========================== */
function renderSales(){
  const tbody = document.querySelector('#salesTable tbody'); tbody.innerHTML='';
  state.sales.forEach((s, index) => {
    const items = s.items ? s.items.map(i=>`${i.name} x${i.qty} @ ${fmt(i.price)}`).join(', ') : 'No items';
    const tr=document.createElement('tr');
    const isSaved = s.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>' 
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
    
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${s.date}</td><td>${s.customer}</td><td>${items}</td><td>${fmt(s.total)}</td><td>${statusBadge}</td>
      <td>
        <button class="btn btn-secondary small" onclick="printSale('${s.id}')">üñ®Ô∏è</button>
        ${!isSaved ? `<button class="btn btn-primary small" onclick="editSale(${index})">Edit</button>` : ''}
        ${!isSaved ? `<button class="btn btn-danger small" onclick="deleteSale('${s.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markSaleSaved('${s.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteSale('${s.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function openSaleModal(){ 
  const user = currentUser();
  if(!user || !user.canCreateSales) { alert('You do not have permission to create sales'); return; }
  document.getElementById('saleForm').reset();
  document.getElementById('saleId').value = '';
  document.getElementById('saleItems').innerHTML='';
  addSaleItem();
  document.getElementById('saleTotalDisplay').innerText = 'Total: UGX 0';
  document.getElementById('saleModal').style.display='flex';
}

function closeSaleModal(){document.getElementById('saleModal').style.display='none';}

function addSaleItem(prefItemId){
  const div=document.createElement('div'); div.style.display='flex'; div.style.gap='5px'; div.style.marginBottom='6px';
  const select = document.createElement('select'); select.required = true;
  (state.inventory.length ? state.inventory : [{id:'',name:'-- no items --',cost:0}]).forEach(i=>{
    const opt = document.createElement('option');
    opt.value = i.id;
    opt.dataset.cost = i.cost;
    opt.textContent = i.name + (i.qty!==undefined ? ` (stock:${i.qty})` : '');
    if(prefItemId && prefItemId === i.id) opt.selected = true;
    select.appendChild(opt);
  });
  const qty = document.createElement('input'); qty.type='number'; qty.placeholder='Qty'; qty.min=1; qty.required=true; qty.value=1; qty.style.width='80px';
  const price = document.createElement('input'); price.type='number'; price.placeholder='Price'; price.style.width='120px'; price.required=true;
  select.addEventListener('change', ()=>{
    const sel = state.inventory.find(it=>it.id === select.value);
    price.value = sel ? sel.cost : 0;
    updateSaleTotal();
  });
  const rm = document.createElement('button'); rm.type='button'; rm.textContent='‚ùå'; rm.onclick = ()=>{ div.remove(); updateSaleTotal(); };
  qty.addEventListener('input', updateSaleTotal);
  price.addEventListener('input', updateSaleTotal);

  div.appendChild(select);
  div.appendChild(qty);
  div.appendChild(price);
  div.appendChild(rm);
  document.getElementById('saleItems').appendChild(div);
  updateSaleTotal();
}

function updateSaleTotal(){
  let total = 0;
  document.querySelectorAll('#saleItems div').forEach(div=>{
    const sel = div.querySelector('select'); const qty = Number(div.querySelector('input[type=number]').value||0);
    const inputs = div.querySelectorAll('input[type=number]');
    const price = Number(inputs[1].value||0);
    total += qty * price;
  });
  const flat = Number(document.getElementById('saleDiscount').value||0);
  const pct = Number(document.getElementById('saleDiscountPct').value||0);
  const pctAmount = total * (pct/100);
  const final = Math.max(0, total - (flat || 0) - pctAmount);
  document.getElementById('saleTotalDisplay').innerText = `Total: ${fmt(final)}`;
  return final;
}
document.getElementById('saleDiscount').addEventListener('input', updateSaleTotal);
document.getElementById('saleDiscountPct').addEventListener('input', updateSaleTotal);

document.getElementById('saleForm').addEventListener('submit', e=>{
  e.preventDefault();
  const saleId = document.getElementById('saleId').value;
  const customer=document.getElementById('customerName').value;
  const contact=document.getElementById('customerContact').value;
  const items=[];
  let total=0;
  let valid=true;
  
  document.querySelectorAll('#saleItems div').forEach(div=>{
    const sel=div.querySelector('select'); const qty=Number(div.querySelector('input[type=number]').value||0);
    const price = Number(div.querySelectorAll('input[type=number]')[1].value||0);
    const itemInv = state.inventory.find(i=>i.id===sel.value);
    const name = itemInv ? itemInv.name : sel.options[sel.selectedIndex].text;
    if(qty <= 0){ valid=false; }
    items.push({id: sel.value, name, qty: qty, price: price});
    total += price * qty;
    // reduce inventory quantity if matching item exists
    if(itemInv){
      itemInv.qty = Number(itemInv.qty) - qty;
      if(itemInv.qty < 0) itemInv.qty = 0;
    }
  });
  if(!valid) { alert('Please enter valid quantities'); return; }
  
  const flat = Number(document.getElementById('saleDiscount').value||0);
  const pct = Number(document.getElementById('saleDiscountPct').value||0);
  const pctAmount = total * (pct/100);
  const final = Math.max(0, total - flat - pctAmount);
  
  const saleData = {id:saleId || idf(), date:new Date().toISOString().slice(0,10), customer, contact, items, total:final, meta:{flatDiscount:flat, pctDiscount:pct}, saved:false};
  
  if(saleId){
    // Editing existing
    const index = state.sales.findIndex(s => s.id === saleId);
    if(index >= 0) state.sales[index] = saleData;
  } else {
    state.sales.push(saleData);
  }
  
  save(); renderSales(); renderInventory(); closeSaleModal();
});

function editSale(index){
  const s = state.sales[index];
  if(!s || s.saved) return alert('Cannot edit saved sales');
  
  document.getElementById('saleId').value = s.id;
  document.getElementById('customerName').value = s.customer;
  document.getElementById('customerContact').value = s.contact || '';
  document.getElementById('saleDiscount').value = s.meta?.flatDiscount || 0;
  document.getElementById('saleDiscountPct').value = s.meta?.pctDiscount || 0;
  
  document.getElementById('saleItems').innerHTML = '';
  s.items.forEach(item => {
    addSaleItem(item.id);
    const lastDiv = document.getElementById('saleItems').lastChild;
    const inputs = lastDiv.querySelectorAll('input[type=number]');
    inputs[0].value = item.qty;
    inputs[1].value = item.price;
  });
  
  updateSaleTotal();
  document.getElementById('saleModal').style.display='flex';
}

function deleteSale(id){
  if(!confirm('Delete this sale?')) return;
  const sale = state.sales.find(s=>s.id===id);
  if(sale && sale.saved) return alert('Cannot delete saved sales');
  
  if(sale && sale.items){
    sale.items.forEach(it=>{
      const inv = state.inventory.find(i=>i.id===it.id);
      if(inv) inv.qty = Number(inv.qty) + Number(it.qty);
    });
  }
  state.sales = state.sales.filter(s=>s.id!==id);
  save(); renderSales(); renderRecords(); renderInventory();
}

function adminDeleteSale(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(!confirm('Admin delete this saved sale?')) return;
  
  const sale = state.sales.find(s=>s.id===id);
  if(sale && sale.items){
    sale.items.forEach(it=>{
      const inv = state.inventory.find(i=>i.id===it.id);
      if(inv) inv.qty = Number(inv.qty) + Number(it.qty);
    });
  }
  state.sales = state.sales.filter(s=>s.id!==id);
  save(); renderSales(); renderRecords(); renderInventory();
}

function markSaleSaved(id){
  const sale = state.sales.find(s => s.id === id);
  if(sale) {
    sale.saved = true;
    save();
    renderSales();
  }
}

function printSale(id){
  const s=state.sales.find(s=>s.id===id);
  if(!s) return alert('Sale not found');
  let html = companyHeaderHTML();
  html += `<h3 style="text-align:center">Receipt</h3><p>Customer: ${s.customer}<br>Contact: ${s.contact}<br>Date: ${s.date}</p><table border="1" style="width:100%;border-collapse:collapse;"><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr>`;
  s.items.forEach(i=>{html+=`<tr><td>${i.name}</td><td>${i.qty}</td><td>${fmt(i.price)}</td><td>${fmt(i.qty * i.price)}</td></tr>`});
  html+=`</table><p><strong>Total: ${fmt(s.total)}</strong></p>`;
  const w=window.open(''); w.document.write(html); w.print();
}

function printSales(){
  const html=companyHeaderHTML()+'<h3>All Sales</h3>'+document.querySelector('#salesTable').outerHTML; 
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   INVENTORY (with save status)
   =========================== */
function renderInventory(){
  const tbody=document.querySelector('#inventoryTable tbody'); tbody.innerHTML='';
  state.inventory.forEach((item, index) => {
    const tr=document.createElement('tr');
    const isSaved = item.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>' 
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
    
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${item.name}</td><td>${item.category||''}</td><td>${item.supplier||''}</td><td>${item.qty}</td><td>${fmt(item.cost)}</td><td>${item.reorder||''}</td><td>${statusBadge}</td>
      <td>
        ${!isSaved ? `<button class="btn btn-primary small" onclick="editInventory(${index})">Edit</button>` : ''}
        ${!isSaved ? `<button class="btn btn-danger small" onclick="deleteInventory('${item.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markInventorySaved('${item.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteInventory('${item.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function openInventoryModal(){document.getElementById('inventoryForm').reset();document.getElementById('itemId').value='';document.getElementById('inventoryModal').style.display='flex';}
function closeInventoryModal(){document.getElementById('inventoryModal').style.display='none';}

document.getElementById('inventoryForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id=document.getElementById('itemId').value;
  const existing = state.inventory.find(i=>i.id===id);
  const created = existing ? existing.created : new Date().toISOString().slice(0,10);
  const item={id: id || idf(),
    name:document.getElementById('itemName').value,
    category:document.getElementById('itemCategory').value,
    supplier:document.getElementById('itemSupplier').value,
    qty:Number(document.getElementById('itemQty').value),
    cost:Number(document.getElementById('itemCost').value),
    reorder:Number(document.getElementById('itemReorder').value),
    created,
    saved: false
  };
  
  if(id){
    const index=state.inventory.findIndex(i=>i.id===id);
    if(index >= 0) state.inventory[index] = item;
  } else {
    state.inventory.push(item);
  }
  save(); renderInventory(); closeInventoryModal();
});

function editInventory(index){
  const i = state.inventory[index];
  if(!i || i.saved) return alert('Cannot edit saved items');
  
  document.getElementById('itemId').value=i.id;
  document.getElementById('itemName').value=i.name;
  document.getElementById('itemCategory').value=i.category||'';
  document.getElementById('itemSupplier').value=i.supplier||'';
  document.getElementById('itemQty').value=i.qty;
  document.getElementById('itemCost').value=i.cost;
  document.getElementById('itemReorder').value=i.reorder||5;
  document.getElementById('inventoryModal').style.display='flex';
}

function deleteInventory(id){
  const item = state.inventory.find(i=>i.id===id);
  if(item && item.saved) return alert('Cannot delete saved items');
  if(confirm('Delete this item?')){
    state.inventory=state.inventory.filter(i=>i.id!==id);
    save();renderInventory();renderRecords();
  }
}

function adminDeleteInventory(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(confirm('Admin delete this saved item?')){
    state.inventory=state.inventory.filter(i=>i.id!==id);
    save();renderInventory();renderRecords();
  }
}

function markInventorySaved(id){
  const item = state.inventory.find(i => i.id === id);
  if(item) {
    item.saved = true;
    save();
    renderInventory();
  }
}

function printInventory(){
  const html=companyHeaderHTML()+'<h3>Inventory Report</h3>'+document.querySelector('#inventoryTable').outerHTML; 
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   EXPENSES (with save status)
   =========================== */
function renderExpenses(){
  const tbody=document.querySelector('#expensesTable tbody'); tbody.innerHTML='';
  let total=0;
  state.expenses.forEach((e, index) => {
    total+=Number(e.amount);
    const tr=document.createElement('tr');
    const isSaved = e.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>' 
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
    
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${e.date}</td><td>${e.category}</td><td>${e.description}</td><td>${fmt(e.amount)}</td><td>${statusBadge}</td>
      <td>
        ${!isSaved ? `<button class="btn btn-primary small" onclick="editExpense(${index})">Edit</button>` : ''}
        ${!isSaved ? `<button class="btn btn-danger small" onclick="deleteExpense('${e.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markExpenseSaved('${e.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteExpense('${e.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('expenseTotal').innerText='Total: '+fmt(total);
}

function openExpenseModal(){document.getElementById('expenseForm').reset();document.getElementById('expenseId').value='';document.getElementById('expenseModal').style.display='flex';}
function closeExpenseModal(){document.getElementById('expenseModal').style.display='none';}

document.getElementById('expenseForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id = document.getElementById('expenseId').value;
  const exp={id: id || idf(), date:document.getElementById('expenseDate').value, category:document.getElementById('expenseCategory').value, description:document.getElementById('expenseDesc').value, amount:Number(document.getElementById('expenseAmount').value), saved: false};
  
  if(id){
    const index = state.expenses.findIndex(e => e.id === id);
    if(index >= 0) state.expenses[index] = exp;
  } else {
    state.expenses.push(exp);
  }
  save(); renderExpenses(); renderRecords(); closeExpenseModal();
});

function editExpense(index){
  const e = state.expenses[index];
  if(!e || e.saved) return alert('Cannot edit saved expenses');
  
  document.getElementById('expenseId').value = e.id;
  document.getElementById('expenseDate').value = e.date;
  document.getElementById('expenseCategory').value = e.category;
  document.getElementById('expenseDesc').value = e.description;
  document.getElementById('expenseAmount').value = e.amount;
  document.getElementById('expenseModal').style.display='flex';
}

function deleteExpense(id){
  const expense = state.expenses.find(e=>e.id===id);
  if(expense && expense.saved) return alert('Cannot delete saved expenses');
  if(!confirm('Delete this expense?')) return;
  state.expenses=state.expenses.filter(e=>e.id!==id);
  save(); renderExpenses(); renderRecords();
}

function adminDeleteExpense(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(!confirm('Admin delete this saved expense?')) return;
  state.expenses=state.expenses.filter(e=>e.id!==id);
  save(); renderExpenses(); renderRecords();
}

function markExpenseSaved(id){
  const expense = state.expenses.find(e => e.id === id);
  if(expense) {
    expense.saved = true;
    save();
    renderExpenses();
  }
}

function searchExpenses(){
  const from=document.getElementById('expenseFrom').value; const to=document.getElementById('expenseTo').value;
  const tbody=document.querySelector('#expensesTable tbody'); tbody.innerHTML='';
  let total=0;
  state.expenses.filter(e=>(!from || e.date>=from) && (!to || e.date<=to)).forEach((e, index) => {
    total+=Number(e.amount);
    const tr=document.createElement('tr');
    const isSaved = e.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>' 
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
    
    tr.innerHTML=`<td>${e.date}</td><td>${e.category}</td><td>${e.description}</td><td>${fmt(e.amount)}</td><td>${statusBadge}</td>
      <td>
        ${!isSaved ? `<button class="btn btn-primary small" onclick="editExpense(${index})">Edit</button>` : ''}
        ${!isSaved ? `<button class="btn btn-danger small" onclick="deleteExpense('${e.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markExpenseSaved('${e.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteExpense('${e.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('expenseTotal').innerText='Total: '+fmt(total);
}

function printExpenses(){
  const html=companyHeaderHTML()+'<h3>Expenses Report</h3>'+document.querySelector('#expensesTable').outerHTML; 
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   EMPLOYEES (with save status)
   =========================== */
function renderEmployees(){
  const tbody=document.querySelector('#employeesTable tbody'); tbody.innerHTML='';
  state.employees.forEach((e, index) => {
    const tr=document.createElement('tr');
    const isSaved = e.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>' 
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
    
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${e.name}</td><td>${e.position||''}</td><td>${e.email||''}</td><td>${e.phone||''}</td><td>${statusBadge}</td>
      <td>
        ${!isSaved ? `<button class="btn btn-primary small" onclick="editEmployee(${index})">Edit</button>` : ''}
        ${!isSaved ? `<button class="btn btn-danger small" onclick="deleteEmployee('${e.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markEmployeeSaved('${e.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteEmployee('${e.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function openEmployeeModal(){document.getElementById('employeeForm').reset();document.getElementById('employeeId').value='';document.getElementById('employeeModal').style.display='flex';}
function closeEmployeeModal(){document.getElementById('employeeModal').style.display='none';}

document.getElementById('employeeForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id=document.getElementById('employeeId').value;
  const emp={id: id || idf(), name:document.getElementById('employeeName').value, position:document.getElementById('employeePosition').value, email:document.getElementById('employeeEmail').value, phone:document.getElementById('employeePhone').value, saved: false};
  
  if(id){
    const index=state.employees.findIndex(x=>x.id===id);
    if(index >= 0) state.employees[index]=emp;
  } else {
    state.employees.push(emp);
  }
  save(); renderEmployees(); closeEmployeeModal();
});

function editEmployee(index){
  const e = state.employees[index];
  if(!e || e.saved) return alert('Cannot edit saved employees');
  
  document.getElementById('employeeId').value=e.id;
  document.getElementById('employeeName').value=e.name;
  document.getElementById('employeePosition').value=e.position||'';
  document.getElementById('employeeEmail').value=e.email||'';
  document.getElementById('employeePhone').value=e.phone||'';
  document.getElementById('employeeModal').style.display='flex';
}

function deleteEmployee(id){
  const emp = state.employees.find(e=>e.id===id);
  if(emp && emp.saved) return alert('Cannot delete saved employees');
  if(confirm('Delete employee?')){
    state.employees=state.employees.filter(e=>e.id!==id);
    save();renderEmployees();
  }
}

function adminDeleteEmployee(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(confirm('Admin delete this saved employee?')){
    state.employees=state.employees.filter(e=>e.id!==id);
    save();renderEmployees();
  }
}

function markEmployeeSaved(id){
  const emp = state.employees.find(e => e.id === id);
  if(emp) {
    emp.saved = true;
    save();
    renderEmployees();
  }
}

function printEmployees(){
  const html=companyHeaderHTML()+'<h3>Employees Report</h3>'+document.querySelector('#employeesTable').outerHTML; 
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   SUPPLIERS (with save status)
   =========================== */
function renderSuppliers(){
  const tbody=document.querySelector('#suppliersTable tbody'); tbody.innerHTML='';
  state.suppliers.forEach((s, index) => {
    const tr=document.createElement('tr');
    const isSaved = s.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>' 
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
    
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${s.name}</td><td>${s.contact||''}</td><td>${s.email||''}</td><td>${statusBadge}</td>
      <td>
        ${!isSaved ? `<button class="btn btn-primary small" onclick="editSupplier(${index})">Edit</button>` : ''}
        ${!isSaved ? `<button class="btn btn-danger small" onclick="deleteSupplier('${s.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markSupplierSaved('${s.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteSupplier('${s.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function openSupplierModal(){document.getElementById('supplierForm').reset();document.getElementById('supplierId').value='';document.getElementById('supplierModal').style.display='flex';}
function closeSupplierModal(){document.getElementById('supplierModal').style.display='none';}

document.getElementById('supplierForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id=document.getElementById('supplierId').value;
  const sup={id: id || idf(), name:document.getElementById('supplierName').value, contact:document.getElementById('supplierContact').value, email:document.getElementById('supplierEmail').value, saved: false};
  
  if(id){
    const index=state.suppliers.findIndex(x=>x.id===id);
    if(index >= 0) state.suppliers[index]=sup;
  } else {
    state.suppliers.push(sup);
  }
  save(); renderSuppliers(); closeSupplierModal();
});

function editSupplier(index){
  const s = state.suppliers[index];
  if(!s || s.saved) return alert('Cannot edit saved suppliers');
  
  document.getElementById('supplierId').value=s.id;
  document.getElementById('supplierName').value=s.name;
  document.getElementById('supplierContact').value=s.contact||'';
  document.getElementById('supplierEmail').value=s.email||'';
  document.getElementById('supplierModal').style.display='flex';
}

function deleteSupplier(id){
  const sup = state.suppliers.find(s=>s.id===id);
  if(sup && sup.saved) return alert('Cannot delete saved suppliers');
  if(confirm('Delete supplier?')){
    state.suppliers=state.suppliers.filter(s=>s.id!==id);
    save();renderSuppliers();
  }
}

function adminDeleteSupplier(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(confirm('Admin delete this saved supplier?')){
    state.suppliers=state.suppliers.filter(s=>s.id!==id);
    save();renderSuppliers();
  }
}

function markSupplierSaved(id){
  const sup = state.suppliers.find(s => s.id === id);
  if(sup) {
    sup.saved = true;
    save();
    renderSuppliers();
  }
}

function printSuppliers(){
  const html=companyHeaderHTML()+'<h3>Suppliers Report</h3>'+document.querySelector('#suppliersTable').outerHTML; 
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   DEPOSITS (enhanced with item tracking and automated balance)
   =========================== */
function renderDeposits(){
  const tbody=document.querySelector('#depositsTable tbody'); tbody.innerHTML='';
  state.deposits.forEach((d, index) => {
    const tr=document.createElement('tr');
    const isSaved = d.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>' 
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
    const remainingBalance = Number(d.amount) - Number(d.used || 0);
    
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${d.date}</td><td>${d.client}</td><td>${d.item || 'N/A'}</td><td>${fmt(d.amount)}</td><td>${fmt(remainingBalance)}</td><td>${statusBadge}</td>
      <td>
        <button class="btn btn-secondary small" onclick="printDeposit('${d.id}')">üñ®Ô∏è</button>
        ${!isSaved ? `<button class="btn btn-primary small" onclick="editDeposit(${index})">Edit</button>` : ''}
        ${!isSaved ? `<button class="btn btn-danger small" onclick="deleteDeposit('${d.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markDepositSaved('${d.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteDeposit('${d.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function openDepositModal(){
  document.getElementById('depositForm').reset();
  document.getElementById('depositId').value='';
  document.getElementById('depositDate').value = new Date().toISOString().slice(0,10);
  document.getElementById('depositModal').style.display='flex';
}
function closeDepositModal(){document.getElementById('depositModal').style.display='none';}

document.getElementById('depositForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id=document.getElementById('depositId').value;
  const amount = Number(document.getElementById('depositAmount').value);
  const used = Number(document.getElementById('depositUsed').value || 0);
  
  const dep={
    id: id || idf(),
    date:document.getElementById('depositDate').value,
    client:document.getElementById('depositClient').value,
    item:document.getElementById('depositItem').value,
    amount: amount,
    used: used,
    remainingBalance: amount - used,
    saved: false
  };
  
  if(id){
    const index=state.deposits.findIndex(x=>x.id===id);
    if(index >= 0) state.deposits[index]=dep;
  } else {
    state.deposits.push(dep);
  }
  save(); renderDeposits(); renderRecords(); closeDepositModal();
});

function editDeposit(index){
  const d = state.deposits[index];
  if(!d || d.saved) return alert('Cannot edit saved deposits');
  
  document.getElementById('depositId').value = d.id;
  document.getElementById('depositDate').value = d.date;
  document.getElementById('depositClient').value = d.client;
  document.getElementById('depositItem').value = d.item || '';
  document.getElementById('depositAmount').value = d.amount;
  document.getElementById('depositUsed').value = d.used || 0;
  document.getElementById('depositModal').style.display='flex';
}

function deleteDeposit(id){
  const dep = state.deposits.find(d=>d.id===id);
  if(dep && dep.saved) return alert('Cannot delete saved deposits');
  if(confirm('Delete deposit?')){
    state.deposits=state.deposits.filter(d=>d.id!==id);
    save();renderDeposits();renderRecords();
  }
}

function adminDeleteDeposit(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(confirm('Admin delete this saved deposit?')){
    state.deposits=state.deposits.filter(d=>d.id!==id);
    save();renderDeposits();renderRecords();
  }
}

function markDepositSaved(id){
  const dep = state.deposits.find(d => d.id === id);
  if(dep) {
    dep.saved = true;
    save();
    renderDeposits();
  }
}

function printDeposit(id){
  const d=state.deposits.find(d=>d.id===id);
  if(!d) return alert('Deposit not found');
  let html = companyHeaderHTML();
  html += `<h3 style="text-align:center">Deposit Receipt</h3>`;
  html += `<p>Client: ${d.client}<br>Date: ${d.date}</p>`;
  html += `<p>Item Deposited On: ${d.item || 'N/A'}</p>`;
  html += `<table border="1" style="width:100%;border-collapse:collapse;">`;
  html += `<tr><th>Initial Amount</th><td>${fmt(d.amount)}</td></tr>`;
  html += `<tr><th>Amount Used</th><td>${fmt(d.used || 0)}</td></tr>`;
  html += `<tr><th>Remaining Balance</th><td>${fmt(d.remainingBalance || (d.amount - (d.used || 0)))}</td></tr>`;
  html += `</table>`;
  const w=window.open(''); w.document.write(html); w.print();
}

function printDeposits(){
  const html=companyHeaderHTML()+'<h3>Deposits Report</h3>'+document.querySelector('#depositsTable').outerHTML; 
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   RECORDS (with pagination + filters)
   =========================== */
function buildRecordsArray(){
  const arr = [];
  // Sales
  state.sales.forEach(s=>{
    arr.push({
      type: 'Sale',
      date: s.date,
      ref: s.id,
      details: `Customer: ${s.customer}`,
      amount: s.total,
      meta: s.items ? s.items.map(i=>`${i.name} x${i.qty}`).join(', ') : 'No items'
    });
  });
  // Expenses
  state.expenses.forEach(e=>{
    arr.push({
      type: 'Expense',
      date: e.date,
      ref: e.id,
      details: `${e.category} - ${e.description}`,
      amount: Number(e.amount),
      meta: e.notes||''
    });
  });
  // Inventory
  state.inventory.forEach(i=>{
    arr.push({
      type: 'Inventory',
      date: i.created || new Date().toISOString().slice(0,10),
      ref: i.id,
      details: `${i.name} (${i.category||''})`,
      amount: i.qty,
      meta: `Cost: ${fmt(i.cost)} Supplier:${i.supplier||''}`
    });
  });
  // Deposits
  state.deposits.forEach(d=>{
    arr.push({
      type: 'Deposit',
      date: d.date,
      ref: d.id,
      details: `Client: ${d.client}, Item: ${d.item || 'N/A'}`,
      amount: d.amount,
      meta: `Used: ${fmt(d.used || 0)}, Remaining: ${fmt(d.remainingBalance || (d.amount - (d.used || 0)))}`
    });
  });
  // Sort desc by date
  return arr.sort((a,b)=> a.date < b.date ? 1 : (a.date > b.date ? -1 : 0));
}

/* Pagination state */
let recordsPage = 1;
function renderRecords(list){
  const tbody=document.querySelector('#recordsTable tbody'); tbody.innerHTML='';
  const rowsAll = list || buildRecordsArray();
  let rows = rowsAll;
  const typeFilter = document.getElementById('recordsType') ? document.getElementById('recordsType').value : '';
  const textFilter = document.getElementById('recordsText') ? document.getElementById('recordsText').value.toLowerCase() : '';
  if(typeFilter) rows = rows.filter(r=>r.type === typeFilter);
  if(textFilter) rows = rows.filter(r=> (r.details+' '+r.ref+' '+r.meta).toLowerCase().includes(textFilter));
  const from=document.getElementById('recordsFrom') ? document.getElementById('recordsFrom').value : '';
  const to=document.getElementById('recordsTo') ? document.getElementById('recordsTo').value : '';
  rows = rows.filter(r=> (!from || r.date >= from) && (!to || r.date <= to));

  const pageSize = Number(document.getElementById('recordsPageSize').value||10);
  const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
  if(recordsPage > totalPages) recordsPage = totalPages;
  const start = (recordsPage-1) * pageSize;
  const pageRows = rows.slice(start, start + pageSize);

  let totalMoney = 0;
  let totalQty = 0;
  pageRows.forEach(r=>{
    const tr=document.createElement('tr');
    let amountDisplay = '';
    if(r.type === 'Sale' || r.type === 'Expense' || r.type === 'Deposit') { amountDisplay = fmt(r.amount); totalMoney += Number(r.amount||0); }
    else { amountDisplay = r.amount; totalQty += Number(r.amount||0); }
    tr.innerHTML = `<td>${r.type}</td><td>${r.date}</td><td>${r.ref}</td><td>${r.details}<div style="font-size:0.9em;color:#cbd5e1;margin-top:4px">${r.meta||''}</div></td><td>${amountDisplay}</td>
      <td>
        ${r.type === 'Sale' ? `<button class="btn btn-secondary small" onclick="printSale('${r.ref}')">üñ®Ô∏è</button>` : ''}
        ${r.type === 'Expense' ? `<button class="btn btn-secondary small" onclick="printExpense('${r.ref}')">üñ®Ô∏è</button>` : ''}
        ${r.type === 'Inventory' ? `<button class="btn btn-secondary small" onclick="printInventoryItem('${r.ref}')">üñ®Ô∏è</button>` : ''}
        ${r.type === 'Deposit' ? `<button class="btn btn-secondary small" onclick="printDeposit('${r.ref}')">üñ®Ô∏è</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' ? `<button class="btn btn-danger small" onclick="adminDeleteRecord('${r.type}','${r.ref}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
  const summary = `Total on page (money): ${fmt(totalMoney)} ‚Äî Total inventory qty on page: ${totalQty} ‚Äî Showing ${pageRows.length} of ${rows.length} records`;
  document.getElementById('recordsSummary').innerText = summary;
  document.getElementById('recordsPagerInfo').innerText = `Page ${recordsPage} / ${totalPages}`;
}

function searchRecords(){ recordsPage = 1; renderRecords(); }
function printRecords(){
  const html=companyHeaderHTML()+'<h3>Company Records (current page)</h3>'+document.querySelector('#recordsTable').outerHTML;
  const w=window.open(''); w.document.write(html); w.print();
}

function adminDeleteRecord(type, ref){
  const user = currentUser();
  if(!user || user.role !== 'admin'){ alert('Admin access required'); return; }
  if(!confirm(`Admin delete this ${type}?`)) return;
  if(type === 'Sale') adminDeleteSale(ref);
  else if(type === 'Expense') adminDeleteExpense(ref);
  else if(type === 'Inventory') adminDeleteInventory(ref);
  else if(type === 'Deposit') adminDeleteDeposit(ref);
  renderAll();
}

/* helper prints */
function printExpense(id){
  const e = state.expenses.find(x=>x.id===id); 
  if(!e) return alert('Expense not found');
  let html = companyHeaderHTML();
  html += `<h3>Expense Receipt</h3><p>${e.date}</p><p>${e.category} - ${e.description}</p><p>Amount: ${fmt(e.amount)}</p>`;
  const w=window.open(''); w.document.write(html); w.print();
}

function printInventoryItem(id){
  const i=state.inventory.find(x=>x.id===id); 
  if(!i) return alert('Item not found');
  let html = companyHeaderHTML();
  html += `<h3>Inventory Item</h3><p>${i.name}</p><p>Category: ${i.category||'N/A'}</p><p>Qty: ${i.qty}</p><p>Cost: ${fmt(i.cost)}</p>`;
  const w=window.open(''); w.document.write(html); w.print();
}

/* pagination helpers */
function recordsNext(){ recordsPage++; renderRecords(); }
function recordsPrev(){ if(recordsPage>1) recordsPage--; renderRecords(); }
function recordsJump(){ const v = Number(document.getElementById('recordsGoto').value||1); recordsPage = Math.max(1, v); renderRecords(); }

/* ===========================
   USERS / SETTINGS (admin only)
   =========================== */
function openUserModal(){
  document.getElementById('userForm').reset();
  document.getElementById('userId').value='';
  populateUsersList();
  document.getElementById('userModal').style.display='flex';
}
function closeUserModal(){ document.getElementById('userModal').style.display='none'; }

function populateUsersList(){
  const el = document.getElementById('usersList'); el.innerHTML='';
  state.users.forEach(u=>{
    const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.padding='6px 0';
    const left = document.createElement('div'); left.innerHTML = `<strong>${u.username}</strong> <span class="muted">(${u.role})</span> ${u.canViewRecords?'<span class="muted">‚Ä¢ records</span>':''}`;
    const right = document.createElement('div');
    const edit = document.createElement('button'); edit.className='btn small'; edit.textContent='Edit'; edit.onclick=()=>{ editUser(u.id); };
    const del = document.createElement('button'); del.className='btn small'; del.textContent='Delete'; del.onclick=()=>{ if(confirm('Delete user?')){ state.users = state.users.filter(x=>x.id!==u.id); save(); populateUsersList(); } };
    right.appendChild(edit); right.appendChild(del);
    div.appendChild(left); div.appendChild(right);
    el.appendChild(div);
  });
}

function editUser(id){
  const u = state.users.find(x=>x.id===id); if(!u) return;
  document.getElementById('userId').value = u.id;
  document.getElementById('userName').value = u.username;
  document.getElementById('userPass').value = u.password;
  document.getElementById('userRole').value = u.role;
  document.getElementById('userCanViewRecords').checked = !!u.canViewRecords;
  document.getElementById('userCanCreateSales').checked = (u.canCreateSales !== false);
  document.getElementById('userModal').style.display = 'flex';
}

document.getElementById('userForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id = document.getElementById('userId').value || idf();
  const username = document.getElementById('userName').value.trim();
  const password = document.getElementById('userPass').value;
  const role = document.getElementById('userRole').value;
  const canViewRecords = document.getElementById('userCanViewRecords').checked;
  const canCreateSales = document.getElementById('userCanCreateSales').checked;
  if(state.users.some(u=>u.username === username && u.id !== id)){ alert('Username already exists'); return; }
  const existingIndex = state.users.findIndex(u=>u.id===id);
  const userObj = {id, username, password, role, canViewRecords, canCreateSales};
  if(existingIndex >= 0) state.users[existingIndex] = userObj; else state.users.push(userObj);
  save(); populateUsersList(); closeUserModal();
});

/* ===========================
   COMPANY SETTINGS
   =========================== */
document.getElementById('companyForm').addEventListener('submit', e=>{
  e.preventDefault();
  state.company = {
    name: document.getElementById('companyName').value,
    location: document.getElementById('companyLocation').value,
    box: document.getElementById('companyBox').value,
    tel: document.getElementById('companyTel').value,
    email: document.getElementById('companyEmail').value
  };
  save(); 
  alert('Company details saved successfully!');
});

/* SETTINGS area render (Admin-only) */
function renderSettingsAdmin(){
  const container = document.getElementById('settingsAdminArea'); container.innerHTML='';
  const user = currentUser();
  if(!user || user.role !== 'admin'){ 
    container.innerHTML = '<p class="muted">Only admin can manage users and company settings.</p>'; 
    return; 
  }
  container.innerHTML = '<p>Configure system preferences here. (Admin only: manage users)</p>';
  const btn = document.createElement('button'); btn.className='btn btn-primary'; btn.textContent='Manage Users'; btn.onclick = openUserModal;
  container.appendChild(btn);
  
  // Load company settings
  if(state.company){
    document.getElementById('companyName').value = state.company.name || '';
    document.getElementById('companyLocation').value = state.company.location || '';
    document.getElementById('companyBox').value = state.company.box || '';
    document.getElementById('companyTel').value = state.company.tel || '';
    document.getElementById('companyEmail').value = state.company.email || '';
  }
}

/* ===========================
   AUTH UI updates & helpers
   =========================== */
function updateUIForAuth(){
  const user = currentUser();
  document.getElementById('currentUserDisplay').innerText = user ? `Signed in as: ${user.username} (${user.role})` : 'Not signed in';
  document.getElementById('systemStatus').innerText = user ? 'Online' : 'Offline';
  const newSaleBtn = document.getElementById('newSaleBtn');
  if(newSaleBtn) newSaleBtn.disabled = !(user && user.canCreateSales);
  renderSettingsAdmin();
  // restrict nav items visibility
  document.querySelectorAll("#navList .nav-item").forEach(nav=>{
    if(nav.dataset.view === 'records'){
      nav.style.display = (user && user.canViewRecords) ? 'flex' : 'none';
    } else {
      nav.style.display = 'flex';
    }
  });
  if(!user) showLogin(); else hideLogin();
  const qa = document.getElementById('quickUserActions'); qa.innerHTML='';
  if(user){
    const profileBtn = document.createElement('button'); profileBtn.className='btn small'; profileBtn.textContent='Profile'; 
    profileBtn.onclick = ()=>{ alert(`Profile: ${user.username} (${user.role})\nRecords Access: ${user.canViewRecords ? 'Yes' : 'No'}\nSales Creation: ${user.canCreateSales ? 'Yes' : 'No'}`); };
    qa.appendChild(profileBtn);
  }
}

/* ===========================
   RENDER ALL (initial)
   =========================== */
function renderAll(){
  renderSales(); 
  renderInventory(); 
  renderExpenses(); 
  renderEmployees(); 
  renderSuppliers(); 
  renderDeposits(); 
  renderRecords(); 
  renderSettingsAdmin();
  updateUIForAuth();
  updateDashboard();
}

// Initialize
renderAll();
if(!currentUser()) showLogin(); else hideLogin();
</script>
</body>
</html>
