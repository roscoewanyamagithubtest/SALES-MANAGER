<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales System ‚Äî All-in-One (with Enhanced Admin Control)</title>
  <style>
    :root{
      --bg1:#0f2027; --bg2:#203a43; --bg3:#2c5364;
      --panel:#1a1f29; --card:#242b38;
      --accent:#06b6d4; --accent2:#7c3aed;
      --radius:12px; --muted:#94a3b8;
      font-family: Inter, ui-sans-serif, system-ui;
      color-scheme: dark;
    }
    *{box-sizing:border-box;}
    body{margin:0;min-height:100vh;display:flex;background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));color:#e6eef8;}
    .app{flex:1;display:flex;}
    .sidebar{width:240px;background:var(--panel);padding:20px;display:flex;flex-direction:column;}
    .logo{display:flex;align-items:center;gap:10px;margin-bottom:20px;}
    .logo h1{font-size:1.1em;margin:0;}
    .nav-item{padding:10px;border-radius:var(--radius);cursor:pointer;display:flex;align-items:center;gap:10px;}
    .nav-item:hover,.nav-item.active{background:var(--accent);color:#fff;}
    .nav-item.disabled{opacity:0.5;cursor:not-allowed;background:rgba(100,100,100,0.3)!important;}
    .main{flex:1;padding:20px;overflow:auto;}
    .card{background:var(--card);padding:20px;border-radius:var(--radius);margin-bottom:20px;box-shadow:0 4px 8px rgba(0,0,0,0.2);}
    .table{width:100%;border-collapse:collapse;}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left;}
    .btn{padding:6px 12px;border:none;border-radius:var(--radius);cursor:pointer;}
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-danger{background:#ef4444;color:#fff;}
    .btn-secondary{background:#64748b;color:#fff;}
    .btn-prepaid{background:#f59e0b;color:#fff;}
    .muted{color:var(--muted);font-size:0.9em}
    .small{font-size:0.9em;padding:4px 8px}
    .unsaved{background-color:rgba(255,215,0,0.1);border-left:4px solid #ffd700;}
    .saved{background-color:rgba(34,197,94,0.1);border-left:4px solid #22c55e;}
    /* Modals */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;}
    .modal .modal-box{background:#fff;color:#000;padding:20px;width:600px;max-height:90%;overflow:auto;border-radius:var(--radius);}
    .modal input,.modal select,.modal textarea{width:100%;padding:8px;margin:5px 0;}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
    .right{margin-left:auto;display:flex;gap:10px;align-items:center;}
    .badge{background:rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;}
    .disabled{opacity:0.5;pointer-events:none;}
    label.inline{display:inline-block;margin-right:8px;}
    .paging{display:flex;gap:6px;align-items:center;}
    .permission-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin:10px 0;}
    .permission-item{background:#f8f9fa;padding:10px;border-radius:8px;display:flex;align-items:center;gap:8px;}
    .search-container{display:flex;gap:10px;margin:10px 0;align-items:center;flex-wrap:wrap;}
    .company-branding{text-align:center;margin:10px 0;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;}
    .deposit-customer{background:rgba(34,197,94,0.1);padding:10px;border-radius:8px;margin-bottom:10px;border-left:4px solid #22c55e;}
    .balance-info{font-weight:bold;color:#22c55e;margin:10px 0;padding:10px;background:rgba(34,197,94,0.1);border-radius:8px;}
    @media(max-width:768px){
      .sidebar{width:70px;padding:10px;}
      .sidebar .logo h1,.sidebar .nav-item div{display:none;}
      .table{font-size:0.85em;}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo"><div class="mark">üìä</div><h1>SALES SYSTEM</h1></div>
    <nav id="navList">
      <div class="nav-item active" data-view="dashboard">üè† Dashboard</div>
      <div class="nav-item" data-view="sales">üßæ Sales</div>
      <div class="nav-item" data-view="inventory">üì¶ Inventory</div>
      <div class="nav-item" data-view="expenses">üí∏ Expenses</div>
      <div class="nav-item" data-view="employees">üë• Employees</div>
      <div class="nav-item" data-view="suppliers">üöö Suppliers</div>
      <div class="nav-item" data-view="deposits">üè¶ Deposits</div>
      <div class="nav-item" data-view="tax-invoice">üìã Tax Invoice</div>
      <div class="nav-item" data-view="records">üìÅ Records</div>
      <div class="nav-item" data-view="settings">‚öôÔ∏è Settings</div>
    </nav>
    <div style="margin-top:auto;margin-left:4px;">
      <div id="currentUserDisplay" class="muted"></div>
      <div style="margin-top:8px;"><button class="btn small" onclick="logout()">Logout</button></div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="badge" id="systemStatus">Offline</div>
      <div class="muted">Client-side demo ‚Äî data stored in localStorage</div>
      <div class="right">
        <div id="quickUserActions"></div>
      </div>
    </div>

    <!-- Dashboard -->
    <section data-view="dashboard" class="view card">
      <h2>Dashboard</h2>
      <p>Welcome to your Sales System overview.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:20px;">
        <div class="card" style="text-align:center;">
          <h3>Total Sales</h3>
          <div style="font-size:2em;color:var(--accent);" id="dashTotalSales">UGX 0</div>
        </div>
        <div class="card" style="text-align:center;">
          <h3>Total Expenses</h3>
          <div style="font-size:2em;color:#ef4444;" id="dashTotalExpenses">UGX 0</div>
        </div>
        <div class="card" style="text-align:center;">
          <h3>Inventory Items</h3>
          <div style="font-size:2em;color:#22c55e;" id="dashInventoryCount">0</div>
        </div>
        <div class="card" style="text-align:center;">
          <h3>Deposits Amount</h3>
          <div style="font-size:2em;color:#f59e0b;" id="dashTotalDeposits">UGX 0</div>
        </div>
      </div>
    </section>

    <!-- Access Denied Message -->
    <section id="accessDenied" class="view card" style="display:none">
      <h2>Access Denied</h2>
      <p style="color:#ef4444;">You do not have permission to access this section. Please contact your administrator for access.</p>
      <p class="muted">Your current permissions are managed by the system administrator.</p>
    </section>

    <!-- Sales -->
    <section data-view="sales" class="view card" style="display:none">
      <h2>Sales
        <button class="btn btn-primary" id="newSaleBtn" onclick="openSaleModal()">+ New Sale</button>
        <button class="btn btn-prepaid" onclick="openPrepaidSaleModal()">üí∞ Prepaid Sale</button>
        <button class="btn btn-secondary" onclick="printSales()">üñ®Ô∏è Print All Sales</button>
      </h2>
      <table class="table" id="salesTable">
        <thead><tr><th>Date</th><th>Customer</th><th>Items</th><th>Total</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Inventory -->
    <section data-view="inventory" class="view card" style="display:none">
      <h2>Inventory
        <button class="btn btn-primary" onclick="openInventoryModal()">+ Add Item</button>
        <button class="btn btn-secondary" onclick="printInventory()">üñ®Ô∏è Print</button>
      </h2>
      <table class="table" id="inventoryTable">
        <thead>
          <tr><th>Item</th><th>Category</th><th>Supplier</th><th>Qty</th><th>Cost</th><th>Reorder</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Tax Invoice -->
    <section data-view="tax-invoice" class="view card" style="display:none">
      <h2>Tax Invoice
        <button class="btn btn-primary" onclick="openTaxInvoiceModal()">+ Create Tax Invoice</button>
        <button class="btn btn-secondary" onclick="printTaxInvoices()">üñ®Ô∏è Print All Tax Invoices</button>
      </h2>
      <table class="table" id="taxInvoiceTable">
        <thead><tr><th>Date</th><th>Invoice No.</th><th>Customer</th><th>Total Amount</th><th>VAT</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Expenses -->
    <section data-view="expenses" class="view card" style="display:none">
      <h2>Expenses
        <button class="btn btn-primary" onclick="openExpenseModal()">+ Add Expense</button>
        <button class="btn btn-secondary" onclick="printExpenses()">üñ®Ô∏è Print</button>
      </h2>
      <div style="margin:10px 0;">
        <label>From: <input type="date" id="expenseFrom"></label>
        <label>To: <input type="date" id="expenseTo"></label>
        <button class="btn btn-secondary" onclick="searchExpenses()">üîç Search</button>
        <button class="btn btn-secondary" onclick="renderExpenses()">Reset</button>
      </div>
      <table class="table" id="expensesTable">
        <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="6" id="expenseTotal" style="text-align:right;font-weight:bold;"></td></tr>
        </tfoot>
      </table>
    </section>

    <!-- Employees -->
    <section data-view="employees" class="view card" style="display:none">
      <h2>Employees
        <button class="btn btn-primary" onclick="openEmployeeModal()">+ Add Employee</button>
        <button class="btn btn-secondary" onclick="printEmployees()">üñ®Ô∏è Print</button>
      </h2>
      <table class="table" id="employeesTable">
        <thead>
          <tr><th>Name</th><th>Position</th><th>Email</th><th>Phone</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Suppliers -->
    <section data-view="suppliers" class="view card" style="display:none">
      <h2>Suppliers
        <button class="btn btn-primary" onclick="openSupplierModal()">+ Add Supplier</button>
        <button class="btn btn-secondary" onclick="printSuppliers()">üñ®Ô∏è Print</button>
      </h2>
      <table class="table" id="suppliersTable">
        <thead>
          <tr><th>Name</th><th>Contact</th><th>Email</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Deposits -->
    <section data-view="deposits" class="view card" style="display:none">
      <h2>Deposits
        <button class="btn btn-primary" onclick="openDepositModal()">+ Add Deposit</button>
        <button class="btn btn-secondary" onclick="printDeposits()">üñ®Ô∏è Print</button>
      </h2>
      <div class="search-container">
        <label>Search Customer: <input id="depositSearchCustomer" placeholder="Search by customer name" onkeyup="searchDepositsLive()" /></label>
        <button class="btn btn-secondary" onclick="searchDeposits()">üîç Search</button>
        <button class="btn btn-secondary" onclick="renderDeposits()">Reset</button>
      </div>
      <div id="depositSearchResults" style="display:none;" class="deposit-customer">
        <h4>Customer Found:</h4>
        <div id="foundCustomerInfo"></div>
        <div class="balance-info" id="balanceDisplay"></div>
        <button class="btn btn-primary" onclick="depositForCustomer()">üí∞ Deposit for this Customer</button>
      </div>
      <table class="table" id="depositsTable">
        <thead>
          <tr><th>Date</th><th>Client</th><th>Item</th><th>Amount</th><th>Balance</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Records -->
    <section data-view="records" class="view card" style="display:none">
      <h2>Company Records</h2>

      <div style="margin:10px 0;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label>From: <input type="date" id="recordsFrom"></label>
        <label>To: <input type="date" id="recordsTo"></label>
        <label>Type:
          <select id="recordsType">
            <option value="">All</option>
            <option>Sale</option>
            <option>Expense</option>
            <option>Inventory</option>
            <option>Deposit</option>
            <option>Tax Invoice</option>
            <option>Prepaid Sale</option>
          </select>
        </label>
        <label>Text: <input id="recordsText" placeholder="search details/ref/meta" /></label>
        <button class="btn btn-secondary" onclick="searchRecords()">üîç Search Records</button>
        <button class="btn btn-secondary" onclick="renderRecords()">Reset</button>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <label class="inline">Page size:
            <select id="recordsPageSize" onchange="renderRecords()"><option>10</option><option>25</option><option>50</option></select>
          </label>
          <button class="btn btn-secondary" onclick="printRecords()">üñ®Ô∏è Print Records</button>
        </div>
      </div>

      <table class="table" id="recordsTable">
        <thead>
          <tr><th>Type</th><th>Date</th><th>Reference</th><th>Details</th><th>Amount / Qty</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="6" id="recordsSummary" style="text-align:right;font-weight:bold;"></td></tr>
        </tfoot>
      </table>

      <div style="margin-top:8px;display:flex;justify-content:flex-end;align-items:center;gap:8px;">
        <div class="paging">
          <button class="btn small" onclick="recordsPrev()">Prev</button>
          <span id="recordsPagerInfo" class="muted">Page 1 / 1</span>
          <button class="btn small" onclick="recordsNext()">Next</button>
        </div>
        <div>
          <label>Go to: <input id="recordsGoto" type="number" style="width:70px" /></label>
          <button class="btn small" onclick="recordsJump()">Go</button>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section data-view="settings" class="view card" style="display:none">
      <h2>Settings</h2>
      <div id="settingsAdminArea"></div>
      <hr/>
      <h3>Company Details (printed on receipts)</h3>
      <form id="companyForm">
        <label>Company Name</label><input id="companyName" />
        <label>Location</label><input id="companyLocation" />
        <label>P.O. Box</label><input id="companyBox" />
        <label>Telephone</label><input id="companyTel" />
        <label>Email</label><input id="companyEmail" />
        <div style="text-align:right;margin-top:8px;">
          <button type="submit" class="btn btn-primary" id="saveCompanyBtn">Save Company</button>
        </div>
      </form>
      <hr/>
      <h3>Software Builder Details</h3>
      <form id="builderForm">
        <label>Builder Name</label><input id="builderName" />
        <label>Builder Contact</label><input id="builderContact" />
        <label>Builder Website</label><input id="builderWebsite" />
        <div style="text-align:right;margin-top:8px;">
          <button type="submit" class="btn btn-primary" id="saveBuilderBtn">Save Builder Info</button>
        </div>
      </form>
    </section>
  </main>
</div>

<!-- LOGIN Modal -->
<div id="loginModal" class="modal" style="display:flex">
  <div class="modal-box">
    <div class="company-branding" id="loginCompanyBranding"></div>
    <h2>Login</h2>
    <form id="loginForm">
      <label>Username</label><input id="loginUsername" required/>
      <label>Password</label><input id="loginPassword" type="password" required/>
      <div style="margin-top:10px;text-align:right;">
        <button type="submit" class="btn btn-primary">Login</button>
      </div>
    </form>
    <p class="muted" style="margin-top:8px">Default admin: <strong>admin</strong> / <strong>admin123</strong>. (client-side demo)</p>
  </div>
</div>

<!-- User Management Modal (admin only) -->
<div id="userModal" class="modal">
  <div class="modal-box">
    <h2>Manage Users</h2>
    <form id="userForm">
      <input type="hidden" id="userId" />
      <label>Username</label><input id="userName" required />
      <label>Password</label><input id="userPass" type="password" />
      <label>Role</label>
      <select id="userRole">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
     
      <h4 style="margin-top:15px;">Navigation Access Permissions</h4>
      <div class="permission-grid">
        <div class="permission-item">
          <input type="checkbox" id="userCanViewSales" checked />
          <label>Sales</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanViewInventory" checked />
          <label>Inventory</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanViewExpenses" checked />
          <label>Expenses</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanViewEmployees" />
          <label>Employees</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanViewSuppliers" />
          <label>Suppliers</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanViewDeposits" />
          <label>Deposits</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanViewTaxInvoice" />
          <label>Tax Invoice</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanViewRecords" />
          <label>Records</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanViewSettings" />
          <label>Settings</label>
        </div>
      </div>
     
      <h4 style="margin-top:15px;">Action Permissions</h4>
      <div class="permission-grid">
        <div class="permission-item">
          <input type="checkbox" id="userCanCreateSales" checked />
          <label>Create Sales</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanEditData" />
          <label>Edit Data</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanDeleteData" />
          <label>Delete Data</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanManageUsers" />
          <label>Manage Users</label>
        </div>
        <div class="permission-item">
          <input type="checkbox" id="userCanSaveSettings" />
          <label>Save Settings</label>
        </div>
      </div>
     
      <div style="margin-top:15px;text-align:right;">
        <button type="submit" class="btn btn-primary" id="saveUserBtn">Save User</button>
        <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
      </div>
    </form>
    <hr/>
    <h3>Existing users</h3>
    <div id="usersList"></div>
  </div>
</div>

<!-- Sale Modal -->
<div id="saleModal" class="modal">
  <div class="modal-box">
    <h2>New Sale</h2>
    <form id="saleForm">
      <input type="hidden" id="saleId"/>
      <label>Customer</label><input id="customerName" required/>
      <label>Phone Number</label><input id="customerContact" required/>
      <div style="display:flex;gap:8px;align-items:center;margin:8px 0;">
        <label class="inline">Sale discount (flat):</label><input id="saleDiscount" type="number" value="0" style="width:120px"/>
        <label class="inline">Sale discount (%) :</label><input id="saleDiscountPct" type="number" value="0" style="width:80px"/>
      </div>
      <div id="saleItems"></div>
      <button type="button" class="btn btn-secondary" onclick="addSaleItem()">+ Add Product</button>
      <div style="margin-top:10px;text-align:right;">
        <strong id="saleTotalDisplay">Total: UGX 0</strong>
      </div>
      <div style="margin-top:10px;text-align:right;">
        <button type="submit" class="btn btn-primary">Save Sale</button>
        <button type="button" class="btn btn-secondary" onclick="closeSaleModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Prepaid Sale Modal -->
<div id="prepaidSaleModal" class="modal">
  <div class="modal-box">
    <h2>Prepaid Sale</h2>
    <form id="prepaidSaleForm">
      <label>Search Customer:</label>
      <input id="prepaidCustomerSearch" placeholder="Type customer name" onkeyup="searchCustomersForPrepaid()" />
      <div id="prepaidCustomerResults"></div>
     
      <div id="prepaidSaleDetails" style="display:none;">
        <hr>
        <div id="selectedCustomerInfo"></div>
        <div class="balance-info" id="selectedCustomerBalance"></div>
       
        <div id="prepaidSaleItems"></div>
        <button type="button" class="btn btn-secondary" onclick="addPrepaidSaleItem()">+ Add Product</button>
       
        <div style="margin-top:10px;text-align:right;">
          <strong id="prepaidSaleTotalDisplay">Total: UGX 0</strong>
        </div>
       
        <div style="margin-top:10px;text-align:right;">
          <button type="submit" class="btn btn-prepaid">Process Prepaid Sale</button>
          <button type="button" class="btn btn-secondary" onclick="closePrepaidSaleModal()">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Tax Invoice Modal -->
<div id="taxInvoiceModal" class="modal">
  <div class="modal-box">
    <h2>Create Tax Invoice</h2>
    <form id="taxInvoiceForm">
      <input type="hidden" id="taxInvoiceId"/>
      <label>Invoice Number</label><input id="taxInvoiceNumber" required/>
      <label>Customer</label><input id="taxInvoiceCustomer" required/>
      <label>Phone Number</label><input id="taxInvoiceContact" required/>
      <div id="taxInvoiceItems"></div>
      <button type="button" class="btn btn-secondary" onclick="addTaxInvoiceItem()">+ Add Item</button>
      <div style="margin-top:10px;text-align:right;">
        <strong id="taxInvoiceTotalDisplay">Total: UGX 0</strong><br>
        <strong id="taxInvoiceVATDisplay">VAT: UGX 0</strong><br>
        <strong id="taxInvoiceGrandTotalDisplay">Grand Total: UGX 0</strong>
      </div>
      <div style="margin-top:10px;text-align:right;">
        <button type="submit" class="btn btn-primary">Save Tax Invoice</button>
        <button type="button" class="btn btn-secondary" onclick="closeTaxInvoiceModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Inventory Modal -->
<div id="inventoryModal" class="modal">
  <div class="modal-box">
    <h2>Add / Edit Item</h2>
    <form id="inventoryForm">
      <input type="hidden" id="itemId"/>
      <label>Item</label><input id="itemName" required/>
      <label>Category</label><input id="itemCategory"/>
      <label>Supplier</label><input id="itemSupplier"/>
      <label>Quantity</label><input id="itemQty" type="number" required/>
      <label>Cost (per unit)</label><input id="itemCost" type="number" required/>
      <label>Reorder Level</label><input id="itemReorder" type="number" value="5"/>
      <div style="text-align:right;margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Expense Modal -->
<div id="expenseModal" class="modal">
  <div class="modal-box">
    <h2>Add Expense</h2>
    <form id="expenseForm">
      <input type="hidden" id="expenseId"/>
      <label>Date</label><input type="date" id="expenseDate" required/>
      <label>Category</label><input id="expenseCategory" required/>
      <label>Description</label><input id="expenseDesc" required/>
      <label>Amount</label><input type="number" id="expenseAmount" required/>
      <div style="text-align:right;margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeExpenseModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Employee Modal -->
<div id="employeeModal" class="modal">
  <div class="modal-box">
    <h2>Add / Edit Employee</h2>
    <form id="employeeForm">
      <input type="hidden" id="employeeId"/>
      <label>Name</label><input id="employeeName" required/>
      <label>Position</label><input id="employeePosition"/>
      <label>Email</label><input id="employeeEmail"/>
      <label>Phone</label><input id="employeePhone"/>
      <div style="text-align:right;margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Supplier Modal -->
<div id="supplierModal" class="modal">
  <div class="modal-box">
    <h2>Add / Edit Supplier</h2>
    <form id="supplierForm">
      <input type="hidden" id="supplierId"/>
      <label>Name</label><input id="supplierName" required/>
      <label>Contact</label><input id="supplierContact"/>
      <label>Email</label><input id="supplierEmail"/>
      <div style="text-align:right;margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeSupplierModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Deposit Modal -->
<div id="depositModal" class="modal">
  <div class="modal-box">
    <h2>Add Deposit</h2>
    <form id="depositForm">
      <input type="hidden" id="depositId"/>
      <input type="hidden" id="depositCustomerId"/>
      <label>Date</label><input type="date" id="depositDate" required/>
      <label>Client</label>
      <input id="depositClient" required list="clientSuggestions"/>
      <datalist id="clientSuggestions"></datalist>
      <label>Item</label><input id="depositItem" required placeholder="What item/service is this deposit for?"/>
      <label>Amount</label><input type="number" id="depositAmount" required/>
      <label>Amount Used (optional)</label><input type="number" id="depositUsed" value="0" placeholder="Amount used from deposit"/>
      <div style="text-align:right;margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="closeDepositModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Top Up Deposit Modal -->
<div id="topUpModal" class="modal">
  <div class="modal-box">
    <h2>Top Up Deposit</h2>
    <form id="topUpForm">
      <input type="hidden" id="topUpDepositId"/>
      <label>Customer</label><input id="topUpCustomer" readonly/>
      <label>Current Balance</label><input id="topUpCurrentBalance" readonly/>
      <label>Top Up Amount</label><input type="number" id="topUpAmount" required min="0"/>
      <div style="text-align:right;margin-top:10px;">
        <button type="submit" class="btn btn-primary">Add Top Up</button>
        <button type="button" class="btn btn-secondary" onclick="closeTopUpModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ===========================
   STORAGE & INITIAL STATE
   =========================== */
const STORAGE_KEY = "sales_system_data_v6_enhanced_prepaid";
const fmt = n => "UGX " + Number(n||0).toLocaleString();
const idf = () => Math.random().toString(36).substr(2,9);

let state = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
if(!state.sales) state.sales=[];
if(!state.inventory) state.inventory=[];
if(!state.expenses) state.expenses=[];
if(!state.employees) state.employees=[];
if(!state.suppliers) state.suppliers=[];
if(!state.deposits) state.deposits=[];
if(!state.taxInvoices) state.taxInvoices=[];
if(!state.prepaidSales) state.prepaidSales=[];
if(!state.users) {
  // default admin user (client-side demo) with full permissions
  state.users = [
    {
      id: idf(),
      username: 'admin',
      password: 'admin123',
      role:'admin',
      permissions: {
        canViewSales: true,
        canViewInventory: true,
        canViewExpenses: true,
        canViewEmployees: true,
        canViewSuppliers: true,
        canViewDeposits: true,
        canViewTaxInvoice: true,
        canViewRecords: true,
        canViewSettings: true,
        canCreateSales: true,
        canEditData: true,
        canDeleteData: true,
        canManageUsers: true,
        canSaveSettings: true
      }
    }
  ];
}
if(!state.meta) state.meta={currentUserId:null};
if(!state.company) state.company={name:'', location:'', box:'', tel:'', email:''};
if(!state.builder) state.builder={name:'Software Builder', contact:'contact@builder.com', website:'www.builder.com'};

// Global variable for currently selected customer in prepaid sale
let selectedPrepaidCustomer = null;

// helper to persist
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); updateUIForAuth(); updateDashboard(); updateLoginBranding(); }

// currently logged in user (object or null)
function currentUser(){ return state.users.find(u=>u.id===state.meta.currentUserId) || null; }

// Check if user has permission for a specific action/view
function hasPermission(permissionKey) {
  const user = currentUser();
  if(!user) return false;
  if(user.role === 'admin') return true; // Admin has all permissions
  return user.permissions && user.permissions[permissionKey];
}

// Company header for all receipts
function companyHeaderHTML(){
  const c = state.company || {};
  const user = currentUser();
  const userInfo = user ? `<div style="margin-top:10px;font-size:0.9em;">Served by: ${user.username}</div>` : '';
  return `<div style="text-align:center;margin-bottom:20px;">` +
         `<h2 style="margin:0;padding:0;">${c.name || 'Sales System'}</h2>` +
         `<div>${c.location || ''} ${c.box ? ('P.O. Box ' + c.box) : ''}</div>` +
         `<div>Tel: ${c.tel || ''} ${c.email ? ('| Email: ' + c.email) : ''}</div>` +
         userInfo +
         `<hr style="border:1px solid #ccc;"/></div>`;
}

// Builder footer for all receipts
function builderFooterHTML(){
  const b = state.builder || {};
  return `<div style="text-align:center;margin-top:30px;font-size:0.8em;color:#666;">` +
         `<hr style="border:1px solid #ccc;"/>` +
         `<p>System built by: ${b.name}<br>` +
         `Contact: ${b.contact} | Website: ${b.website}</p>` +
         `</div>`;
}

// Update dashboard statistics - show deposits amount not total products
function updateDashboard(){
  const totalSales = state.sales.reduce((sum, s) => sum + (s.total || 0), 0);
  const totalPrepaidSales = state.prepaidSales.reduce((sum, s) => sum + (s.total || 0), 0);
  const totalExpenses = state.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
  const inventoryCount = state.inventory.length;
  // Calculate current deposit balances (amount - used)
  const totalDepositBalances = state.deposits.reduce((sum, d) => {
    const balance = Number(d.amount || 0) - Number(d.used || 0);
    return sum + balance;
  }, 0);
 
  const dashSales = document.getElementById('dashTotalSales');
  const dashExpenses = document.getElementById('dashTotalExpenses');
  const dashInventory = document.getElementById('dashInventoryCount');
  const dashDeposits = document.getElementById('dashTotalDeposits');
 
  if(dashSales) dashSales.textContent = fmt(totalSales + totalPrepaidSales);
  if(dashExpenses) dashExpenses.textContent = fmt(totalExpenses);
  if(dashInventory) dashInventory.textContent = inventoryCount;
  if(dashDeposits) dashDeposits.textContent = fmt(totalDepositBalances);
}

// Update login form branding
function updateLoginBranding(){
  const brandingDiv = document.getElementById('loginCompanyBranding');
  const c = state.company || {};
  if(c.name) {
    brandingDiv.innerHTML = `<h3 style="margin:0;color:#333;">${c.name}</h3>` +
                           (c.location ? `<p style="margin:5px 0;color:#666;">${c.location}</p>` : '');
    brandingDiv.style.display = 'block';
  } else {
    brandingDiv.style.display = 'none';
  }
}

/* ===========================
   AUTH (CLIENT-SIDE)
   =========================== */
function showLogin(){
  // Clear login form
  document.getElementById('loginUsername').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginModal').style.display='flex';
}
function hideLogin(){ document.getElementById('loginModal').style.display='none'; }
document.getElementById('loginForm').addEventListener('submit', e=>{
  e.preventDefault();
  const u = document.getElementById('loginUsername').value.trim();
  const p = document.getElementById('loginPassword').value;
  const user = state.users.find(x=>x.username === u && x.password === p);
  if(!user){ alert('Invalid credentials'); return; }
  state.meta.currentUserId = user.id; save(); hideLogin();
  renderAll(); alert('Logged in as '+user.username);
});
function logout(){
  state.meta.currentUserId = null;
  save();
  showLogin();
  renderAll();
}

/* ===========================
   NAVIGATION WITH ACCESS CONTROL
   =========================== */
document.querySelectorAll("#navList .nav-item").forEach(nav=>{
  nav.addEventListener("click", ()=>{
    const user = currentUser();
    const view = nav.dataset.view;
   
    // Check if user has permission to access this view
    const permissionMap = {
      'dashboard': true, // Everyone can access dashboard
      'sales': 'canViewSales',
      'inventory': 'canViewInventory',
      'expenses': 'canViewExpenses',
      'employees': 'canViewEmployees',
      'suppliers': 'canViewSuppliers',
      'deposits': 'canViewDeposits',
      'tax-invoice': 'canViewTaxInvoice',
      'records': 'canViewRecords',
      'settings': 'canViewSettings'
    };
   
    const requiredPermission = permissionMap[view];
    if(requiredPermission !== true && !hasPermission(requiredPermission)) {
      showAccessDenied();
      return;
    }
   
    // Update active nav
    document.querySelectorAll("#navList .nav-item").forEach(n=>n.classList.remove("active"));
    nav.classList.add("active");
   
    // Show the view
    document.querySelectorAll(".view").forEach(sec=>sec.style.display='none');
    document.getElementById('accessDenied').style.display='none';
    document.querySelector(`.view[data-view='${view}']`).style.display='block';
    renderAll();
  });
});

function showAccessDenied(){
  document.querySelectorAll(".view").forEach(sec=>sec.style.display='none');
  document.getElementById('accessDenied').style.display='block';
}

/* ===========================
   HELPER FUNCTIONS FOR CUSTOMER BALANCE
   =========================== */
function getCustomerBalance(customerName) {
  const customerDeposits = state.deposits.filter(d =>
    d.client.toLowerCase().trim() === customerName.toLowerCase().trim()
  );
 
  let totalBalance = 0;
  customerDeposits.forEach(d => {
    totalBalance += Number(d.amount || 0) - Number(d.used || 0);
  });
 
  return totalBalance;
}

function getCustomerDeposits(customerName) {
  return state.deposits.filter(d =>
    d.client.toLowerCase().trim() === customerName.toLowerCase().trim()
  );
}

function useCustomerBalance(customerName, amount) {
  const customerDeposits = state.deposits.filter(d =>
    d.client.toLowerCase().trim() === customerName.toLowerCase().trim() &&
    (Number(d.amount || 0) - Number(d.used || 0)) > 0
  ).sort((a, b) => new Date(a.date) - new Date(b.date)); // Use oldest first
 
  let remainingAmount = amount;
 
  for (let deposit of customerDeposits) {
    if (remainingAmount <= 0) break;
   
    const availableBalance = Number(deposit.amount || 0) - Number(deposit.used || 0);
    const useAmount = Math.min(remainingAmount, availableBalance);
   
    deposit.used = Number(deposit.used || 0) + useAmount;
    remainingAmount -= useAmount;
  }
 
  return remainingAmount === 0;
}

/* ===========================
   SALES (with save status tracking)
   =========================== */
function renderSales(){
  if(!hasPermission('canViewSales')) return;
  const tbody = document.querySelector('#salesTable tbody'); tbody.innerHTML='';
 
  // Combine regular sales and prepaid sales
  const allSales = [
    ...state.sales.map(s => ({...s, type: 'Regular'})),
    ...state.prepaidSales.map(s => ({...s, type: 'Prepaid'}))
  ].sort((a, b) => new Date(b.date) - new Date(a.date));
 
  allSales.forEach((s, index) => {
    const items = s.items ? s.items.map(i=>`${i.name} x${i.qty} @ ${fmt(i.price)}`).join(', ') : 'No items';
    const tr=document.createElement('tr');
    const isSaved = s.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>'
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
   
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${s.date}</td><td>${s.customer}</td><td>${items}</td><td>${fmt(s.total)}</td><td><span style="background:${s.type === 'Prepaid' ? '#f59e0b' : '#06b6d4'};color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">${s.type}</span></td><td>${statusBadge}</td>
      <td>
        <button class="btn btn-secondary small" onclick="printSale('${s.id}', '${s.type}')">üñ®Ô∏è</button>
        ${!isSaved && hasPermission('canEditData') && s.type === 'Regular' ? `<button class="btn btn-primary small" onclick="editSale(${state.sales.findIndex(sale => sale.id === s.id)})">Edit</button>` : ''}
        ${!isSaved && hasPermission('canDeleteData') ? `<button class="btn btn-danger small" onclick="deleteSale('${s.id}', '${s.type}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markSaleSaved('${s.id}', '${s.type}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteSale('${s.id}', '${s.type}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function openSaleModal(){
  if(!hasPermission('canCreateSales')) { alert('You do not have permission to create sales'); return; }
  document.getElementById('saleForm').reset();
  document.getElementById('saleId').value = '';
  document.getElementById('saleItems').innerHTML='';
  addSaleItem();
  document.getElementById('saleTotalDisplay').innerText = 'Total: UGX 0';
  document.getElementById('saleModal').style.display='flex';
}

function closeSaleModal(){document.getElementById('saleModal').style.display='none';}

function addSaleItem(prefItemId){
  const div=document.createElement('div'); div.style.display='flex'; div.style.gap='5px'; div.style.marginBottom='6px';
  const select = document.createElement('select'); select.required = true;
  (state.inventory.length ? state.inventory : [{id:'',name:'-- no items --',cost:0}]).forEach(i=>{
    const opt = document.createElement('option');
    opt.value = i.id;
    opt.dataset.cost = i.cost;
    opt.textContent = i.name + (i.qty!==undefined ? ` (stock:${i.qty})` : '');
    if(prefItemId && prefItemId === i.id) opt.selected = true;
    select.appendChild(opt);
  });
  const qty = document.createElement('input'); qty.type='number'; qty.placeholder='Qty'; qty.min=1; qty.required=true; qty.value=1; qty.style.width='80px';
  const price = document.createElement('input'); price.type='number'; price.placeholder='Price'; price.style.width='120px'; price.required=true;
  select.addEventListener('change', ()=>{
    const sel = state.inventory.find(it=>it.id === select.value);
    price.value = sel ? sel.cost : 0;
    updateSaleTotal();
  });
  const rm = document.createElement('button'); rm.type='button'; rm.textContent='‚ùå'; rm.onclick = ()=>{ div.remove(); updateSaleTotal(); };
  qty.addEventListener('input', updateSaleTotal);
  price.addEventListener('input', updateSaleTotal);

  div.appendChild(select);
  div.appendChild(qty);
  div.appendChild(price);
  div.appendChild(rm);
  document.getElementById('saleItems').appendChild(div);
  updateSaleTotal();
}

function updateSaleTotal(){
  let total = 0;
  document.querySelectorAll('#saleItems div').forEach(div=>{
    const sel = div.querySelector('select'); const qty = Number(div.querySelector('input[type=number]').value||0);
    const inputs = div.querySelectorAll('input[type=number]');
    const price = Number(inputs[1].value||0);
    total += qty * price;
  });
  const flat = Number(document.getElementById('saleDiscount').value||0);
  const pct = Number(document.getElementById('saleDiscountPct').value||0);
  const pctAmount = total * (pct/100);
  const final = Math.max(0, total - (flat || 0) - pctAmount);
  document.getElementById('saleTotalDisplay').innerText = `Total: ${fmt(final)}`;
  return final;
}
document.getElementById('saleDiscount').addEventListener('input', updateSaleTotal);
document.getElementById('saleDiscountPct').addEventListener('input', updateSaleTotal);

document.getElementById('saleForm').addEventListener('submit', e=>{
  e.preventDefault();
  const saleId = document.getElementById('saleId').value;
  const customer=document.getElementById('customerName').value;
  const contact=document.getElementById('customerContact').value;
  const items=[];
  let total=0;
  let valid=true;
 
  document.querySelectorAll('#saleItems div').forEach(div=>{
    const sel=div.querySelector('select'); const qty=Number(div.querySelector('input[type=number]').value||0);
    const price = Number(div.querySelectorAll('input[type=number]')[1].value||0);
    const itemInv = state.inventory.find(i=>i.id===sel.value);
    const name = itemInv ? itemInv.name : sel.options[sel.selectedIndex].text;
    if(qty <= 0){ valid=false; }
    items.push({id: sel.value, name, qty: qty, price: price});
    total += price * qty;
    // reduce inventory quantity if matching item exists
    if(itemInv){
      itemInv.qty = Number(itemInv.qty) - qty;
      if(itemInv.qty < 0) itemInv.qty = 0;
    }
  });
  if(!valid) { alert('Please enter valid quantities'); return; }
 
  const flat = Number(document.getElementById('saleDiscount').value||0);
  const pct = Number(document.getElementById('saleDiscountPct').value||0);
  const pctAmount = total * (pct/100);
  const final = Math.max(0, total - flat - pctAmount);
 
  const saleData = {id:saleId || idf(), date:new Date().toISOString().slice(0,10), customer, contact, items, total:final, meta:{flatDiscount:flat, pctDiscount:pct}, saved:false};
 
  if(saleId){
    // Editing existing
    const index = state.sales.findIndex(s => s.id === saleId);
    if(index >= 0) state.sales[index] = saleData;
  } else {
    state.sales.push(saleData);
  }
 
  save(); renderSales(); renderInventory(); closeSaleModal();
});

function editSale(index){
  if(!hasPermission('canEditData')) { alert('You do not have permission to edit sales'); return; }
  const s = state.sales[index];
  if(!s || s.saved) return alert('Cannot edit saved sales');
 
  document.getElementById('saleId').value = s.id;
  document.getElementById('customerName').value = s.customer;
  document.getElementById('customerContact').value = s.contact || '';
  document.getElementById('saleDiscount').value = s.meta?.flatDiscount || 0;
  document.getElementById('saleDiscountPct').value = s.meta?.pctDiscount || 0;
 
  document.getElementById('saleItems').innerHTML = '';
  s.items.forEach(item => {
    addSaleItem(item.id);
    const lastDiv = document.getElementById('saleItems').lastChild;
    const inputs = lastDiv.querySelectorAll('input[type=number]');
    inputs[0].value = item.qty;
    inputs[1].value = item.price;
  });
 
  updateSaleTotal();
  document.getElementById('saleModal').style.display='flex';
}

function deleteSale(id, type){
  if(!hasPermission('canDeleteData')) { alert('You do not have permission to delete sales'); return; }
 
  let sale;
  if (type === 'Prepaid') {
    sale = state.prepaidSales.find(s=>s.id===id);
  } else {
    sale = state.sales.find(s=>s.id===id);
  }
 
  if(sale && sale.saved) return alert('Cannot delete saved sales');
  if(!confirm('Delete this sale?')) return;
 
  if(sale && sale.items){
    sale.items.forEach(it=>{
      const inv = state.inventory.find(i=>i.id===it.id);
      if(inv) inv.qty = Number(inv.qty) + Number(it.qty);
    });
  }
 
  if (type === 'Prepaid') {
    state.prepaidSales = state.prepaidSales.filter(s=>s.id!==id);
  } else {
    state.sales = state.sales.filter(s=>s.id!==id);
  }
 
  save(); renderSales(); renderRecords(); renderInventory();
}

function adminDeleteSale(id, type){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(!confirm('Admin delete this saved sale?')) return;
 
  let sale;
  if (type === 'Prepaid') {
    sale = state.prepaidSales.find(s=>s.id===id);
  } else {
    sale = state.sales.find(s=>s.id===id);
  }
 
  if(sale && sale.items){
    sale.items.forEach(it=>{
      const inv = state.inventory.find(i=>i.id===it.id);
      if(inv) inv.qty = Number(inv.qty) + Number(it.qty);
    });
  }
 
  if (type === 'Prepaid') {
    state.prepaidSales = state.prepaidSales.filter(s=>s.id!==id);
  } else {
    state.sales = state.sales.filter(s=>s.id!==id);
  }
 
  save(); renderSales(); renderRecords(); renderInventory();
}

function markSaleSaved(id, type){
  let sale;
  if (type === 'Prepaid') {
    sale = state.prepaidSales.find(s => s.id === id);
  } else {
    sale = state.sales.find(s => s.id === id);
  }
 
  if(sale) {
    sale.saved = true;
    save();
    renderSales();
  }
}

function printSale(id, type){
  let s;
  if (type === 'Prepaid') {
    s = state.prepaidSales.find(s=>s.id===id);
  } else {
    s = state.sales.find(s=>s.id===id);
  }
 
  if(!s) return alert('Sale not found');
  let html = companyHeaderHTML();
  html += `<h3 style="text-align:center">${type} Sale Receipt</h3><p>Customer: ${s.customer}<br>Contact: ${s.contact}<br>Date: ${s.date}</p><table border="1" style="width:100%;border-collapse:collapse;"><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr>`;
  s.items.forEach(i=>{html+=`<tr><td>${i.name}</td><td>${i.qty}</td><td>${fmt(i.price)}</td><td>${fmt(i.qty * i.price)}</td></tr>`});
  html+=`</table><p><strong>Total: ${fmt(s.total)}</strong></p>`;
  if (type === 'Prepaid' && s.usedFromBalance) {
    html += `<p><strong>Paid from deposit balance: ${fmt(s.usedFromBalance)}</strong></p>`;
  }
  html += builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

function printSales(){
  const html=companyHeaderHTML()+'<h3>All Sales</h3>'+document.querySelector('#salesTable').outerHTML + builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   PREPAID SALES FUNCTIONALITY
   =========================== */
function openPrepaidSaleModal(){
  if(!hasPermission('canCreateSales')) { alert('You do not have permission to create sales'); return; }
 
  document.getElementById('prepaidSaleForm').reset();
  document.getElementById('prepaidCustomerSearch').value = '';
  document.getElementById('prepaidCustomerResults').innerHTML = '';
  document.getElementById('prepaidSaleDetails').style.display = 'none';
  document.getElementById('prepaidSaleItems').innerHTML = '';
  selectedPrepaidCustomer = null;
  document.getElementById('prepaidSaleModal').style.display = 'flex';
}

function closePrepaidSaleModal(){
  document.getElementById('prepaidSaleModal').style.display = 'none';
  selectedPrepaidCustomer = null;
}

function searchCustomersForPrepaid(){
  const searchTerm = document.getElementById('prepaidCustomerSearch').value.toLowerCase().trim();
  const resultsDiv = document.getElementById('prepaidCustomerResults');
 
  if(searchTerm.length < 2) {
    resultsDiv.innerHTML = '';
    return;
  }
 
  // Get unique customers with deposits
  const customers = [...new Set(state.deposits.map(d => d.client))];
  const matchingCustomers = customers.filter(customer =>
    customer.toLowerCase().includes(searchTerm)
  );
 
  resultsDiv.innerHTML = '';
  matchingCustomers.forEach(customer => {
    const balance = getCustomerBalance(customer);
    if(balance > 0) { // Only show customers with positive balance
      const customerDiv = document.createElement('div');
      customerDiv.style.cssText = 'padding:10px;margin:5px 0;background:#f0f8ff;border-radius:8px;cursor:pointer;border:1px solid #ddd;';
      customerDiv.innerHTML = `<strong>${customer}</strong><br><span style="color:#22c55e;">Balance: ${fmt(balance)}</span>`;
      customerDiv.onclick = () => selectCustomerForPrepaid(customer, balance);
      resultsDiv.appendChild(customerDiv);
    }
  });
 
  if(matchingCustomers.length === 0) {
    resultsDiv.innerHTML = '<p style="color:#666;">No customers found with deposits.</p>';
  } else if(matchingCustomers.filter(c => getCustomerBalance(c) > 0).length === 0) {
    resultsDiv.innerHTML = '<p style="color:#666;">No customers found with positive balance.</p>';
  }
}

function selectCustomerForPrepaid(customerName, balance){
  selectedPrepaidCustomer = customerName;
 
  document.getElementById('selectedCustomerInfo').innerHTML = `<h4>Selected Customer: ${customerName}</h4>`;
  document.getElementById('selectedCustomerBalance').innerHTML = `Available Balance: ${fmt(balance)}`;
 
  document.getElementById('prepaidSaleDetails').style.display = 'block';
  document.getElementById('prepaidCustomerResults').innerHTML = '';
  document.getElementById('prepaidCustomerSearch').value = customerName;
 
  // Clear and add first item
  document.getElementById('prepaidSaleItems').innerHTML = '';
  addPrepaidSaleItem();
}

function addPrepaidSaleItem(){
  const div = document.createElement('div');
  div.style.display = 'flex';
  div.style.gap = '5px';
  div.style.marginBottom = '6px';
 
  const select = document.createElement('select');
  select.required = true;
  select.style.flex = '2';
 
  (state.inventory.length ? state.inventory : [{id:'',name:'-- no items --',cost:0}]).forEach(i => {
    const opt = document.createElement('option');
    opt.value = i.id;
    opt.dataset.cost = i.cost;
    opt.textContent = i.name + (i.qty !== undefined ? ` (stock:${i.qty})` : '');
    select.appendChild(opt);
  });
 
  const qty = document.createElement('input');
  qty.type = 'number';
  qty.placeholder = 'Qty';
  qty.min = 1;
  qty.required = true;
  qty.value = 1;
  qty.style.width = '80px';
 
  const price = document.createElement('input');
  price.type = 'number';
  price.placeholder = 'Price';
  price.style.width = '120px';
  price.required = true;
 
  select.addEventListener('change', () => {
    const sel = state.inventory.find(it => it.id === select.value);
    price.value = sel ? sel.cost : 0;
    updatePrepaidSaleTotal();
  });
 
  const rm = document.createElement('button');
  rm.type = 'button';
  rm.textContent = '‚ùå';
  rm.onclick = () => {
    div.remove();
    updatePrepaidSaleTotal();
  };
 
  qty.addEventListener('input', updatePrepaidSaleTotal);
  price.addEventListener('input', updatePrepaidSaleTotal);
 
  div.appendChild(select);
  div.appendChild(qty);
  div.appendChild(price);
  div.appendChild(rm);
  document.getElementById('prepaidSaleItems').appendChild(div);
 
  // Auto-select first item and set price
  if(state.inventory.length > 0) {
    select.value = state.inventory[0].id;
    price.value = state.inventory[0].cost;
  }
 
  updatePrepaidSaleTotal();
}

function updatePrepaidSaleTotal(){
  let total = 0;
  document.querySelectorAll('#prepaidSaleItems div').forEach(div => {
    const inputs = div.querySelectorAll('input[type=number]');
    const qty = Number(inputs[0].value || 0);
    const price = Number(inputs[1].value || 0);
    total += qty * price;
  });
 
  const customerBalance = selectedPrepaidCustomer ? getCustomerBalance(selectedPrepaidCustomer) : 0;
  const balanceAfterSale = Math.max(0, customerBalance - total);
 
  document.getElementById('prepaidSaleTotalDisplay').innerHTML =
    `Total: ${fmt(total)}<br><small>Balance after sale: ${fmt(balanceAfterSale)}</small>`;
 
  return total;
}

document.getElementById('prepaidSaleForm').addEventListener('submit', e => {
  e.preventDefault();
 
  if (!selectedPrepaidCustomer) {
    alert('Please select a customer first');
    return;
  }
 
  const items = [];
  let total = 0;
  let valid = true;
 
  document.querySelectorAll('#prepaidSaleItems div').forEach(div => {
    const sel = div.querySelector('select');
    const inputs = div.querySelectorAll('input[type=number]');
    const qty = Number(inputs[0].value || 0);
    const price = Number(inputs[1].value || 0);
    const itemInv = state.inventory.find(i => i.id === sel.value);
    const name = itemInv ? itemInv.name : sel.options[sel.selectedIndex].text;
   
    if (qty <= 0) {
      valid = false;
    }
   
    items.push({id: sel.value, name, qty, price});
    total += price * qty;
  });
 
  if (!valid) {
    alert('Please enter valid quantities');
    return;
  }
 
  const customerBalance = getCustomerBalance(selectedPrepaidCustomer);
 
  if (customerBalance < total) {
    alert(`Insufficient balance. Customer balance: ${fmt(customerBalance)}, Sale total: ${fmt(total)}`);
    return;
  }
 
  // Use customer balance
  if (!useCustomerBalance(selectedPrepaidCustomer, total)) {
    alert('Error processing payment from balance');
    return;
  }
 
  // Reduce inventory
  items.forEach(item => {
    const itemInv = state.inventory.find(i => i.id === item.id);
    if (itemInv) {
      itemInv.qty = Number(itemInv.qty) - item.qty;
      if (itemInv.qty < 0) itemInv.qty = 0;
    }
  });
 
  // Create prepaid sale record
  const prepaidSaleData = {
    id: idf(),
    date: new Date().toISOString().slice(0, 10),
    customer: selectedPrepaidCustomer,
    contact: '', // Could be enhanced to store customer contact
    items,
    total,
    usedFromBalance: total,
    saved: false
  };
 
  state.prepaidSales.push(prepaidSaleData);
 
  // Check if customer balance is now zero and remove them from system if requested
  const newBalance = getCustomerBalance(selectedPrepaidCustomer);
  if (newBalance === 0) {
    const shouldRemove = confirm(`${selectedPrepaidCustomer}'s balance is now zero. Remove customer from system?`);
    if (shouldRemove) {
      state.deposits = state.deposits.filter(d =>
        d.client.toLowerCase().trim() !== selectedPrepaidCustomer.toLowerCase().trim()
      );
    }
  }
 
  save();
  renderSales();
  renderInventory();
  renderDeposits();
  renderRecords();
  closePrepaidSaleModal();
 
  // Print receipt automatically
  alert(`Prepaid sale completed successfully! Balance used: ${fmt(total)}`);
  if (confirm('Print receipt?')) {
    printSale(prepaidSaleData.id, 'Prepaid');
  }
});

/* ===========================
   TAX INVOICE (new section)
   =========================== */
function renderTaxInvoices(){
  if(!hasPermission('canViewTaxInvoice')) return;
  const tbody = document.querySelector('#taxInvoiceTable tbody'); tbody.innerHTML='';
  state.taxInvoices.forEach((t, index) => {
    const tr=document.createElement('tr');
    const isSaved = t.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>'
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
   
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${t.date}</td><td>${t.invoiceNumber}</td><td>${t.customer}</td><td>${fmt(t.grandTotal)}</td><td>${fmt(t.vatAmount)}</td><td>${statusBadge}</td>
      <td>
        <button class="btn btn-secondary small" onclick="printTaxInvoice('${t.id}')">üñ®Ô∏è</button>
        ${!isSaved && hasPermission('canEditData') ? `<button class="btn btn-primary small" onclick="editTaxInvoice(${index})">Edit</button>` : ''}
        ${!isSaved && hasPermission('canDeleteData') ? `<button class="btn btn-danger small" onclick="deleteTaxInvoice('${t.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markTaxInvoiceSaved('${t.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteTaxInvoice('${t.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function openTaxInvoiceModal(){
  if(!hasPermission('canCreateSales')) { alert('You do not have permission to create tax invoices'); return; }
  document.getElementById('taxInvoiceForm').reset();
  document.getElementById('taxInvoiceId').value = '';
  document.getElementById('taxInvoiceItems').innerHTML='';
  // Generate invoice number
  const invoiceNumber = 'INV-' + Date.now();
  document.getElementById('taxInvoiceNumber').value = invoiceNumber;
  addTaxInvoiceItem();
  updateTaxInvoiceTotal();
  document.getElementById('taxInvoiceModal').style.display='flex';
}

function closeTaxInvoiceModal(){document.getElementById('taxInvoiceModal').style.display='none';}

function addTaxInvoiceItem(prefItemId){
  const div=document.createElement('div');
  div.style.display='grid';
  div.style.gridTemplateColumns='2fr 1fr 1fr 1fr 1fr 1fr auto';
  div.style.gap='5px';
  div.style.marginBottom='6px';
  div.style.alignItems='center';
 
  const select = document.createElement('select'); select.required = true;
  (state.inventory.length ? state.inventory : [{id:'',name:'-- no items --',cost:0}]).forEach(i=>{
    const opt = document.createElement('option');
    opt.value = i.id;
    opt.dataset.cost = i.cost;
    opt.textContent = i.name;
    if(prefItemId && prefItemId === i.id) opt.selected = true;
    select.appendChild(opt);
  });
 
  const unit = document.createElement('input'); unit.placeholder='Unit'; unit.value='pcs'; unit.style.width='60px';
  const qty = document.createElement('input'); qty.type='number'; qty.placeholder='Qty'; qty.min=1; qty.required=true; qty.value=1; qty.style.width='60px';
  const rate = document.createElement('input'); rate.type='number'; rate.placeholder='Rate'; rate.required=true; rate.style.width='80px';
  const disc = document.createElement('input'); disc.type='number'; disc.placeholder='Disc%'; disc.value=0; disc.min=0; disc.max=100; disc.style.width='60px';
  const vat = document.createElement('input'); vat.type='number'; vat.placeholder='VAT%'; vat.value=18; vat.min=0; vat.style.width='60px';
  const rm = document.createElement('button'); rm.type='button'; rm.textContent='‚ùå'; rm.onclick = ()=>{ div.remove(); updateTaxInvoiceTotal(); };
 
  select.addEventListener('change', ()=>{
    const sel = state.inventory.find(it=>it.id === select.value);
    rate.value = sel ? sel.cost : 0;
    updateTaxInvoiceTotal();
  });
 
  [qty, rate, disc, vat].forEach(input => {
    input.addEventListener('input', updateTaxInvoiceTotal);
  });
 
  div.appendChild(select);
  div.appendChild(unit);
  div.appendChild(qty);
  div.appendChild(rate);
  div.appendChild(disc);
  div.appendChild(vat);
  div.appendChild(rm);
  document.getElementById('taxInvoiceItems').appendChild(div);
  updateTaxInvoiceTotal();
}

function updateTaxInvoiceTotal(){
  let subtotal = 0;
  let totalVAT = 0;
 
  document.querySelectorAll('#taxInvoiceItems > div').forEach(div=>{
    const inputs = div.querySelectorAll('input[type=number]');
    const qty = Number(inputs[0].value||0);
    const rate = Number(inputs[1].value||0);
    const discPct = Number(inputs[2].value||0);
    const vatPct = Number(inputs[3].value||0);
   
    const lineTotal = qty * rate;
    const discountAmount = lineTotal * (discPct/100);
    const afterDiscount = lineTotal - discountAmount;
    const vatAmount = afterDiscount * (vatPct/100);
   
    subtotal += afterDiscount;
    totalVAT += vatAmount;
  });
 
  const grandTotal = subtotal + totalVAT;
 
  document.getElementById('taxInvoiceTotalDisplay').innerText = `Subtotal: ${fmt(subtotal)}`;
  document.getElementById('taxInvoiceVATDisplay').innerText = `VAT: ${fmt(totalVAT)}`;
  document.getElementById('taxInvoiceGrandTotalDisplay').innerText = `Grand Total: ${fmt(grandTotal)}`;
 
  return {subtotal, totalVAT, grandTotal};
}

document.getElementById('taxInvoiceForm').addEventListener('submit', e=>{
  e.preventDefault();
  const taxInvoiceId = document.getElementById('taxInvoiceId').value;
  const invoiceNumber = document.getElementById('taxInvoiceNumber').value;
  const customer = document.getElementById('taxInvoiceCustomer').value;
  const contact = document.getElementById('taxInvoiceContact').value;
  const items = [];
  let valid = true;
 
  document.querySelectorAll('#taxInvoiceItems > div').forEach(div=>{
    const select = div.querySelector('select');
    const inputs = div.querySelectorAll('input');
    const unit = inputs[0].value || 'pcs';
    const qty = Number(inputs[1].value||0);
    const rate = Number(inputs[2].value||0);
    const discPct = Number(inputs[3].value||0);
    const vatPct = Number(inputs[4].value||0);
   
    const itemInv = state.inventory.find(i=>i.id===select.value);
    const name = itemInv ? itemInv.name : select.options[select.selectedIndex].text;
   
    if(qty <= 0) valid = false;
   
    const lineTotal = qty * rate;
    const discountAmount = lineTotal * (discPct/100);
    const afterDiscount = lineTotal - discountAmount;
    const vatAmount = afterDiscount * (vatPct/100);
   
    items.push({
      id: select.value,
      name,
      unit,
      qty,
      rate,
      discPct,
      vatPct,
      lineTotal: afterDiscount,
      vatAmount
    });
   
    // reduce inventory
    if(itemInv){
      itemInv.qty = Number(itemInv.qty) - qty;
      if(itemInv.qty < 0) itemInv.qty = 0;
    }
  });
 
  if(!valid) { alert('Please enter valid quantities'); return; }
 
  const totals = updateTaxInvoiceTotal();
 
  const taxInvoiceData = {
    id: taxInvoiceId || idf(),
    date: new Date().toISOString().slice(0,10),
    invoiceNumber,
    customer,
    contact,
    items,
    subtotal: totals.subtotal,
    vatAmount: totals.totalVAT,
    grandTotal: totals.grandTotal,
    saved: false
  };
 
  if(taxInvoiceId){
    const index = state.taxInvoices.findIndex(t => t.id === taxInvoiceId);
    if(index >= 0) state.taxInvoices[index] = taxInvoiceData;
  } else {
    state.taxInvoices.push(taxInvoiceData);
  }
 
  save(); renderTaxInvoices(); renderInventory(); closeTaxInvoiceModal();
});

function editTaxInvoice(index){
  if(!hasPermission('canEditData')) { alert('You do not have permission to edit tax invoices'); return; }
  const t = state.taxInvoices[index];
  if(!t || t.saved) return alert('Cannot edit saved tax invoices');
 
  document.getElementById('taxInvoiceId').value = t.id;
  document.getElementById('taxInvoiceNumber').value = t.invoiceNumber;
  document.getElementById('taxInvoiceCustomer').value = t.customer;
  document.getElementById('taxInvoiceContact').value = t.contact || '';
 
  document.getElementById('taxInvoiceItems').innerHTML = '';
  t.items.forEach(item => {
    addTaxInvoiceItem(item.id);
    const lastDiv = document.getElementById('taxInvoiceItems').lastChild;
    const inputs = lastDiv.querySelectorAll('input');
    inputs[0].value = item.unit || 'pcs';
    inputs[1].value = item.qty;
    inputs[2].value = item.rate;
    inputs[3].value = item.discPct || 0;
    inputs[4].value = item.vatPct || 18;
  });
 
  updateTaxInvoiceTotal();
  document.getElementById('taxInvoiceModal').style.display='flex';
}

function deleteTaxInvoice(id){
  if(!hasPermission('canDeleteData')) { alert('You do not have permission to delete tax invoices'); return; }
  if(!confirm('Delete this tax invoice?')) return;
  const taxInvoice = state.taxInvoices.find(t=>t.id===id);
  if(taxInvoice && taxInvoice.saved) return alert('Cannot delete saved tax invoices');
 
  if(taxInvoice && taxInvoice.items){
    taxInvoice.items.forEach(it=>{
      const inv = state.inventory.find(i=>i.id===it.id);
      if(inv) inv.qty = Number(inv.qty) + Number(it.qty);
    });
  }
  state.taxInvoices = state.taxInvoices.filter(t=>t.id!==id);
  save(); renderTaxInvoices(); renderRecords(); renderInventory();
}

function adminDeleteTaxInvoice(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(!confirm('Admin delete this saved tax invoice?')) return;
 
  const taxInvoice = state.taxInvoices.find(t=>t.id===id);
  if(taxInvoice && taxInvoice.items){
    taxInvoice.items.forEach(it=>{
      const inv = state.inventory.find(i=>i.id===it.id);
      if(inv) inv.qty = Number(inv.qty) + Number(it.qty);
    });
  }
  state.taxInvoices = state.taxInvoices.filter(t=>t.id!==id);
  save(); renderTaxInvoices(); renderRecords(); renderInventory();
}

function markTaxInvoiceSaved(id){
  const taxInvoice = state.taxInvoices.find(t => t.id === id);
  if(taxInvoice) {
    taxInvoice.saved = true;
    save();
    renderTaxInvoices();
  }
}

function printTaxInvoice(id){
  const t = state.taxInvoices.find(t=>t.id===id);
  if(!t) return alert('Tax invoice not found');
 
  let html = companyHeaderHTML();
  html += `<h3 style="text-align:center">TAX INVOICE</h3>`;
  html += `<p><strong>Invoice No:</strong> ${t.invoiceNumber}<br><strong>Date:</strong> ${t.date}</p>`;
  html += `<p><strong>Bill To:</strong><br>${t.customer}<br>Contact: ${t.contact}</p>`;
  html += `<table border="1" style="width:100%;border-collapse:collapse;">`;
  html += `<tr><th>Item</th><th>Unit</th><th>Qty</th><th>Rate</th><th>Disc%</th><th>VAT%</th><th>Amount</th></tr>`;
 
  t.items.forEach(i=>{
    html += `<tr><td>${i.name}</td><td>${i.unit}</td><td>${i.qty}</td><td>${fmt(i.rate)}</td><td>${i.discPct}%</td><td>${i.vatPct}%</td><td>${fmt(i.lineTotal)}</td></tr>`;
  });
 
  html += `</table>`;
  html += `<div style="text-align:right;margin-top:20px;">`;
  html += `<p><strong>Subtotal: ${fmt(t.subtotal)}</strong></p>`;
  html += `<p><strong>VAT: ${fmt(t.vatAmount)}</strong></p>`;
  html += `<p style="font-size:1.2em;"><strong>Grand Total: ${fmt(t.grandTotal)}</strong></p>`;
  html += `</div>`;
  html += builderFooterHTML();
 
  const w=window.open(''); w.document.write(html); w.print();
}

function printTaxInvoices(){
  const html=companyHeaderHTML()+'<h3>All Tax Invoices</h3>'+document.querySelector('#taxInvoiceTable').outerHTML + builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   INVENTORY (with save status)
   =========================== */
function renderInventory(){
  if(!hasPermission('canViewInventory')) return;
  const tbody=document.querySelector('#inventoryTable tbody'); tbody.innerHTML='';
  state.inventory.forEach((item, index) => {
    const tr=document.createElement('tr');
    const isSaved = item.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>'
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
   
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${item.name}</td><td>${item.category||''}</td><td>${item.supplier||''}</td><td>${item.qty}</td><td>${fmt(item.cost)}</td><td>${item.reorder||''}</td><td>${statusBadge}</td>
      <td>
        ${!isSaved && hasPermission('canEditData') ? `<button class="btn btn-primary small" onclick="editInventory(${index})">Edit</button>` : ''}
        ${!isSaved && hasPermission('canDeleteData') ? `<button class="btn btn-danger small" onclick="deleteInventory('${item.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markInventorySaved('${item.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteInventory('${item.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function openInventoryModal(){
  if(!hasPermission('canCreateSales')) { alert('You do not have permission to add inventory'); return; }
  document.getElementById('inventoryForm').reset();document.getElementById('itemId').value='';document.getElementById('inventoryModal').style.display='flex';
}
function closeInventoryModal(){document.getElementById('inventoryModal').style.display='none';}

document.getElementById('inventoryForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id=document.getElementById('itemId').value;
  const existing = state.inventory.find(i=>i.id===id);
  const created = existing ? existing.created : new Date().toISOString().slice(0,10);
  const item={id: id || idf(),
    name:document.getElementById('itemName').value,
    category:document.getElementById('itemCategory').value,
    supplier:document.getElementById('itemSupplier').value,
    qty:Number(document.getElementById('itemQty').value),
    cost:Number(document.getElementById('itemCost').value),
    reorder:Number(document.getElementById('itemReorder').value),
    created,
    saved: false
  };
 
  if(id){
    const index=state.inventory.findIndex(i=>i.id===id);
    if(index >= 0) state.inventory[index] = item;
  } else {
    state.inventory.push(item);
  }
  save(); renderInventory(); closeInventoryModal();
});

function editInventory(index){
  if(!hasPermission('canEditData')) { alert('You do not have permission to edit inventory'); return; }
  const i = state.inventory[index];
  if(!i || i.saved) return alert('Cannot edit saved items');
 
  document.getElementById('itemId').value=i.id;
  document.getElementById('itemName').value=i.name;
  document.getElementById('itemCategory').value=i.category||'';
  document.getElementById('itemSupplier').value=i.supplier||'';
  document.getElementById('itemQty').value=i.qty;
  document.getElementById('itemCost').value=i.cost;
  document.getElementById('itemReorder').value=i.reorder||5;
  document.getElementById('inventoryModal').style.display='flex';
}

function deleteInventory(id){
  if(!hasPermission('canDeleteData')) { alert('You do not have permission to delete inventory'); return; }
  const item = state.inventory.find(i=>i.id===id);
  if(item && item.saved) return alert('Cannot delete saved items');
  if(confirm('Delete this item?')){
    state.inventory=state.inventory.filter(i=>i.id!==id);
    save();renderInventory();renderRecords();
  }
}

function adminDeleteInventory(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(confirm('Admin delete this saved item?')){
    state.inventory=state.inventory.filter(i=>i.id!==id);
    save();renderInventory();renderRecords();
  }
}

function markInventorySaved(id){
  const item = state.inventory.find(i => i.id === id);
  if(item) {
    item.saved = true;
    save();
    renderInventory();
  }
}

function printInventory(){
  const html=companyHeaderHTML()+'<h3>Inventory Report</h3>'+document.querySelector('#inventoryTable').outerHTML + builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   EXPENSES (with save status)
   =========================== */
function renderExpenses(){
  if(!hasPermission('canViewExpenses')) return;
  const tbody=document.querySelector('#expensesTable tbody'); tbody.innerHTML='';
  let total=0;
  state.expenses.forEach((e, index) => {
    total+=Number(e.amount);
    const tr=document.createElement('tr');
    const isSaved = e.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>'
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
   
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${e.date}</td><td>${e.category}</td><td>${e.description}</td><td>${fmt(e.amount)}</td><td>${statusBadge}</td>
      <td>
        ${!isSaved && hasPermission('canEditData') ? `<button class="btn btn-primary small" onclick="editExpense(${index})">Edit</button>` : ''}
        ${!isSaved && hasPermission('canDeleteData') ? `<button class="btn btn-danger small" onclick="deleteExpense('${e.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markExpenseSaved('${e.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteExpense('${e.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('expenseTotal').innerText='Total: '+fmt(total);
}

function openExpenseModal(){
  if(!hasPermission('canCreateSales')) { alert('You do not have permission to add expenses'); return; }
  document.getElementById('expenseForm').reset();document.getElementById('expenseId').value='';document.getElementById('expenseModal').style.display='flex';
}
function closeExpenseModal(){document.getElementById('expenseModal').style.display='none';}

document.getElementById('expenseForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id = document.getElementById('expenseId').value;
  const exp={id: id || idf(), date:document.getElementById('expenseDate').value, category:document.getElementById('expenseCategory').value, description:document.getElementById('expenseDesc').value, amount:Number(document.getElementById('expenseAmount').value), saved: false};
 
  if(id){
    const index = state.expenses.findIndex(e => e.id === id);
    if(index >= 0) state.expenses[index] = exp;
  } else {
    state.expenses.push(exp);
  }
  save(); renderExpenses(); renderRecords(); closeExpenseModal();
});

function editExpense(index){
  if(!hasPermission('canEditData')) { alert('You do not have permission to edit expenses'); return; }
  const e = state.expenses[index];
  if(!e || e.saved) return alert('Cannot edit saved expenses');
 
  document.getElementById('expenseId').value = e.id;
  document.getElementById('expenseDate').value = e.date;
  document.getElementById('expenseCategory').value = e.category;
  document.getElementById('expenseDesc').value = e.description;
  document.getElementById('expenseAmount').value = e.amount;
  document.getElementById('expenseModal').style.display='flex';
}

function deleteExpense(id){
  if(!hasPermission('canDeleteData')) { alert('You do not have permission to delete expenses'); return; }
  const expense = state.expenses.find(e=>e.id===id);
  if(expense && expense.saved) return alert('Cannot delete saved expenses');
  if(!confirm('Delete this expense?')) return;
  state.expenses=state.expenses.filter(e=>e.id!==id);
  save(); renderExpenses(); renderRecords();
}

function adminDeleteExpense(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(!confirm('Admin delete this saved expense?')) return;
  state.expenses=state.expenses.filter(e=>e.id!==id);
  save(); renderExpenses(); renderRecords();
}

function markExpenseSaved(id){
  const expense = state.expenses.find(e => e.id === id);
  if(expense) {
    expense.saved = true;
    save();
    renderExpenses();
  }
}

function searchExpenses(){
  const from=document.getElementById('expenseFrom').value; const to=document.getElementById('expenseTo').value;
  const tbody=document.querySelector('#expensesTable tbody'); tbody.innerHTML='';
  let total=0;
  state.expenses.filter(e=>(!from || e.date>=from) && (!to || e.date<=to)).forEach((e, index) => {
    total+=Number(e.amount);
    const tr=document.createElement('tr');
    const isSaved = e.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>'
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
   
    tr.innerHTML=`<td>${e.date}</td><td>${e.category}</td><td>${e.description}</td><td>${fmt(e.amount)}</td><td>${statusBadge}</td>
      <td>
        ${!isSaved && hasPermission('canEditData') ? `<button class="btn btn-primary small" onclick="editExpense(${index})">Edit</button>` : ''}
        ${!isSaved && hasPermission('canDeleteData') ? `<button class="btn btn-danger small" onclick="deleteExpense('${e.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markExpenseSaved('${e.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteExpense('${e.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('expenseTotal').innerText='Total: '+fmt(total);
}

function printExpenses(){
  const html=companyHeaderHTML()+'<h3>Expenses Report</h3>'+document.querySelector('#expensesTable').outerHTML + builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   EMPLOYEES (with save status)
   =========================== */
function renderEmployees(){
  if(!hasPermission('canViewEmployees')) return;
  const tbody=document.querySelector('#employeesTable tbody'); tbody.innerHTML='';
  state.employees.forEach((e, index) => {
    const tr=document.createElement('tr');
    const isSaved = e.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>'
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
   
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${e.name}</td><td>${e.position||''}</td><td>${e.email||''}</td><td>${e.phone||''}</td><td>${statusBadge}</td>
      <td>
        ${!isSaved && hasPermission('canEditData') ? `<button class="btn btn-primary small" onclick="editEmployee(${index})">Edit</button>` : ''}
        ${!isSaved && hasPermission('canDeleteData') ? `<button class="btn btn-danger small" onclick="deleteEmployee('${e.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markEmployeeSaved('${e.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteEmployee('${e.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function openEmployeeModal(){
  if(!hasPermission('canCreateSales')) { alert('You do not have permission to add employees'); return; }
  document.getElementById('employeeForm').reset();document.getElementById('employeeId').value='';document.getElementById('employeeModal').style.display='flex';
}
function closeEmployeeModal(){document.getElementById('employeeModal').style.display='none';}

document.getElementById('employeeForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id=document.getElementById('employeeId').value;
  const emp={id: id || idf(), name:document.getElementById('employeeName').value, position:document.getElementById('employeePosition').value, email:document.getElementById('employeeEmail').value, phone:document.getElementById('employeePhone').value, saved: false};
 
  if(id){
    const index=state.employees.findIndex(x=>x.id===id);
    if(index >= 0) state.employees[index]=emp;
  } else {
    state.employees.push(emp);
  }
  save(); renderEmployees(); closeEmployeeModal();
});

function editEmployee(index){
  if(!hasPermission('canEditData')) { alert('You do not have permission to edit employees'); return; }
  const e = state.employees[index];
  if(!e || e.saved) return alert('Cannot edit saved employees');
 
  document.getElementById('employeeId').value=e.id;
  document.getElementById('employeeName').value=e.name;
  document.getElementById('employeePosition').value=e.position||'';
  document.getElementById('employeeEmail').value=e.email||'';
  document.getElementById('employeePhone').value=e.phone||'';
  document.getElementById('employeeModal').style.display='flex';
}

function deleteEmployee(id){
  if(!hasPermission('canDeleteData')) { alert('You do not have permission to delete employees'); return; }
  const emp = state.employees.find(e=>e.id===id);
  if(emp && emp.saved) return alert('Cannot delete saved employees');
  if(confirm('Delete employee?')){
    state.employees=state.employees.filter(e=>e.id!==id);
    save();renderEmployees();
  }
}

function adminDeleteEmployee(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(confirm('Admin delete this saved employee?')){
    state.employees=state.employees.filter(e=>e.id!==id);
    save();renderEmployees();
  }
}

function markEmployeeSaved(id){
  const emp = state.employees.find(e => e.id === id);
  if(emp) {
    emp.saved = true;
    save();
    renderEmployees();
  }
}

function printEmployees(){
  const html=companyHeaderHTML()+'<h3>Employees Report</h3>'+document.querySelector('#employeesTable').outerHTML + builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   SUPPLIERS (with save status)
   =========================== */
function renderSuppliers(){
  if(!hasPermission('canViewSuppliers')) return;
  const tbody=document.querySelector('#suppliersTable tbody'); tbody.innerHTML='';
  state.suppliers.forEach((s, index) => {
    const tr=document.createElement('tr');
    const isSaved = s.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>'
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
   
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${s.name}</td><td>${s.contact||''}</td><td>${s.email||''}</td><td>${statusBadge}</td>
      <td>
        ${!isSaved && hasPermission('canEditData') ? `<button class="btn btn-primary small" onclick="editSupplier(${index})">Edit</button>` : ''}
        ${!isSaved && hasPermission('canDeleteData') ? `<button class="btn btn-danger small" onclick="deleteSupplier('${s.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markSupplierSaved('${s.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteSupplier('${s.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function openSupplierModal(){
  if(!hasPermission('canCreateSales')) { alert('You do not have permission to add suppliers'); return; }
  document.getElementById('supplierForm').reset();document.getElementById('supplierId').value='';document.getElementById('supplierModal').style.display='flex';
}
function closeSupplierModal(){document.getElementById('supplierModal').style.display='none';}

document.getElementById('supplierForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id=document.getElementById('supplierId').value;
  const sup={id: id || idf(), name:document.getElementById('supplierName').value, contact:document.getElementById('supplierContact').value, email:document.getElementById('supplierEmail').value, saved: false};
 
  if(id){
    const index=state.suppliers.findIndex(x=>x.id===id);
    if(index >= 0) state.suppliers[index]=sup;
  } else {
    state.suppliers.push(sup);
  }
  save(); renderSuppliers(); closeSupplierModal();
});

function editSupplier(index){
  if(!hasPermission('canEditData')) { alert('You do not have permission to edit suppliers'); return; }
  const s = state.suppliers[index];
  if(!s || s.saved) return alert('Cannot edit saved suppliers');
 
  document.getElementById('supplierId').value=s.id;
  document.getElementById('supplierName').value=s.name;
  document.getElementById('supplierContact').value=s.contact||'';
  document.getElementById('supplierEmail').value=s.email||'';
  document.getElementById('supplierModal').style.display='flex';
}

function deleteSupplier(id){
  if(!hasPermission('canDeleteData')) { alert('You do not have permission to delete suppliers'); return; }
  const sup = state.suppliers.find(s=>s.id===id);
  if(sup && sup.saved) return alert('Cannot delete saved suppliers');
  if(confirm('Delete supplier?')){
    state.suppliers=state.suppliers.filter(s=>s.id!==id);
    save();renderSuppliers();
  }
}

function adminDeleteSupplier(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(confirm('Admin delete this saved supplier?')){
    state.suppliers=state.suppliers.filter(s=>s.id!==id);
    save();renderSuppliers();
  }
}

function markSupplierSaved(id){
  const sup = state.suppliers.find(s => s.id === id);
  if(sup) {
    sup.saved = true;
    save();
    renderSuppliers();
  }
}

function printSuppliers(){
  const html=companyHeaderHTML()+'<h3>Suppliers Report</h3>'+document.querySelector('#suppliersTable').outerHTML + builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   DEPOSITS (enhanced with search and top-up and prepaid functionality)
   =========================== */
function populateClientSuggestions(){
  const datalist = document.getElementById('clientSuggestions');
  datalist.innerHTML = '';
  const clients = [...new Set(state.deposits.map(d => d.client))];
  clients.forEach(client => {
    const option = document.createElement('option');
    option.value = client;
    datalist.appendChild(option);
  });
}

function renderDeposits(){
  if(!hasPermission('canViewDeposits')) return;
  const tbody=document.querySelector('#depositsTable tbody'); tbody.innerHTML='';
  state.deposits.forEach((d, index) => {
    const tr=document.createElement('tr');
    const isSaved = d.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>'
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
    const remainingBalance = Number(d.amount) - Number(d.used || 0);
   
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${d.date}</td><td>${d.client}</td><td>${d.item || 'N/A'}</td><td>${fmt(d.amount)}</td><td>${fmt(remainingBalance)}</td><td>${statusBadge}</td>
      <td>
        <button class="btn btn-secondary small" onclick="printDeposit('${d.id}')">üñ®Ô∏è</button>
        ${remainingBalance > 0 ? `<button class="btn btn-secondary small" onclick="topUpDeposit('${d.id}')">+ Top Up</button>` : ''}
        ${!isSaved && hasPermission('canEditData') ? `<button class="btn btn-primary small" onclick="editDeposit(${index})">Edit</button>` : ''}
        ${!isSaved && hasPermission('canDeleteData') ? `<button class="btn btn-danger small" onclick="deleteDeposit('${d.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markDepositSaved('${d.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteDeposit('${d.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function searchDepositsLive(){
  const searchTerm = document.getElementById('depositSearchCustomer').value.toLowerCase().trim();
  const resultsDiv = document.getElementById('depositSearchResults');
 
  if(searchTerm.length < 2) {
    resultsDiv.style.display = 'none';
    return;
  }
 
  // Get unique customers with deposits
  const customers = [...new Set(state.deposits.map(d => d.client))];
  const matchingCustomers = customers.filter(customer =>
    customer.toLowerCase().includes(searchTerm)
  );
 
  if(matchingCustomers.length === 1) {
    const customer = matchingCustomers[0];
    const balance = getCustomerBalance(customer);
    const deposits = getCustomerDeposits(customer);
   
    document.getElementById('foundCustomerInfo').innerHTML = `
      <p><strong>Customer:</strong> ${customer}</p>
      <p><strong>Total Deposits:</strong> ${deposits.length}</p>
      <p><strong>Last Deposit:</strong> ${deposits.length > 0 ? deposits[deposits.length - 1].date : 'N/A'}</p>
    `;
    document.getElementById('balanceDisplay').innerHTML = `Available Balance: ${fmt(balance)}`;
    resultsDiv.style.display = 'block';
  } else {
    resultsDiv.style.display = 'none';
  }
}

function searchDeposits(){
  const searchTerm = document.getElementById('depositSearchCustomer').value.toLowerCase();
  if(!searchTerm) {
    renderDeposits();
    return;
  }
 
  const tbody=document.querySelector('#depositsTable tbody'); tbody.innerHTML='';
  const filteredDeposits = state.deposits.filter(d =>
    d.client.toLowerCase().includes(searchTerm)
  );
 
  filteredDeposits.forEach((d, index) => {
    const tr=document.createElement('tr');
    const isSaved = d.saved !== false;
    const statusBadge = isSaved ? '<span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Saved</span>'
                                : '<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Unsaved</span>';
    const remainingBalance = Number(d.amount) - Number(d.used || 0);
   
    tr.className = isSaved ? 'saved' : 'unsaved';
    tr.innerHTML=`<td>${d.date}</td><td>${d.client}</td><td>${d.item || 'N/A'}</td><td>${fmt(d.amount)}</td><td>${fmt(remainingBalance)}</td><td>${statusBadge}</td>
      <td>
        <button class="btn btn-secondary small" onclick="printDeposit('${d.id}')">üñ®Ô∏è</button>
        ${remainingBalance > 0 ? `<button class="btn btn-secondary small" onclick="topUpDeposit('${d.id}')">+ Top Up</button>` : ''}
        ${!isSaved && hasPermission('canEditData') ? `<button class="btn btn-primary small" onclick="editDeposit(${index})">Edit</button>` : ''}
        ${!isSaved && hasPermission('canDeleteData') ? `<button class="btn btn-danger small" onclick="deleteDeposit('${d.id}')">Delete</button>` : ''}
        ${!isSaved ? `<button class="btn btn-secondary small" onclick="markDepositSaved('${d.id}')">Mark Saved</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' && isSaved ? `<button class="btn btn-danger small" onclick="adminDeleteDeposit('${d.id}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function depositForCustomer(){
  const searchTerm = document.getElementById('depositSearchCustomer').value.trim();
  if(!searchTerm) {
    alert('Please search for a customer first');
    return;
  }
 
  openDepositModal();
  document.getElementById('depositClient').value = searchTerm;
  document.getElementById('depositCustomerId').value = searchTerm; // Store customer ID for reference
}

function openDepositModal(){
  if(!hasPermission('canCreateSales')) { alert('You do not have permission to add deposits'); return; }
  document.getElementById('depositForm').reset();
  document.getElementById('depositId').value='';
  document.getElementById('depositCustomerId').value='';
  document.getElementById('depositDate').value = new Date().toISOString().slice(0,10);
  populateClientSuggestions();
  document.getElementById('depositModal').style.display='flex';
}
function closeDepositModal(){document.getElementById('depositModal').style.display='none';}

function topUpDeposit(id){
  if(!hasPermission('canEditData')) { alert('You do not have permission to top up deposits'); return; }
  const deposit = state.deposits.find(d => d.id === id);
  if(!deposit) return alert('Deposit not found');
 
  document.getElementById('topUpDepositId').value = deposit.id;
  document.getElementById('topUpCustomer').value = deposit.client;
  document.getElementById('topUpCurrentBalance').value = fmt(Number(deposit.amount) - Number(deposit.used || 0));
  document.getElementById('topUpAmount').value = '';
  document.getElementById('topUpModal').style.display = 'flex';
}

function closeTopUpModal(){document.getElementById('topUpModal').style.display='none';}

document.getElementById('topUpForm').addEventListener('submit', e=>{
  e.preventDefault();
  const depositId = document.getElementById('topUpDepositId').value;
  const topUpAmount = Number(document.getElementById('topUpAmount').value);
 
  const deposit = state.deposits.find(d => d.id === depositId);
  if(deposit && topUpAmount > 0) {
    deposit.amount = Number(deposit.amount) + topUpAmount;
    deposit.remainingBalance = Number(deposit.amount) - Number(deposit.used || 0);
    save();
    renderDeposits();
    closeTopUpModal();
    alert(`Successfully added ${fmt(topUpAmount)} to ${deposit.client}'s account`);
  }
});

document.getElementById('depositForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id=document.getElementById('depositId').value;
  const amount = Number(document.getElementById('depositAmount').value);
  const used = Number(document.getElementById('depositUsed').value || 0);
  const clientName = document.getElementById('depositClient').value.trim();
 
  // Check if this is a deposit for an existing customer (from search)
  const existingCustomer = document.getElementById('depositCustomerId').value.trim();
 
  const dep={
    id: id || idf(),
    date:document.getElementById('depositDate').value,
    client: clientName,
    item:document.getElementById('depositItem').value,
    amount: amount,
    used: used,
    remainingBalance: amount - used,
    saved: false
  };
 
  if(id){
    const index=state.deposits.findIndex(x=>x.id===id);
    if(index >= 0) state.deposits[index]=dep;
  } else {
    state.deposits.push(dep);
  }
 
  save();
  renderDeposits();
  renderRecords();
  closeDepositModal();
 
  // Hide search results after successful deposit
  document.getElementById('depositSearchResults').style.display = 'none';
  document.getElementById('depositSearchCustomer').value = '';
});

function editDeposit(index){
  if(!hasPermission('canEditData')) { alert('You do not have permission to edit deposits'); return; }
  const d = state.deposits[index];
  if(!d || d.saved) return alert('Cannot edit saved deposits');
 
  document.getElementById('depositId').value = d.id;
  document.getElementById('depositDate').value = d.date;
  document.getElementById('depositClient').value = d.client;
  document.getElementById('depositItem').value = d.item || '';
  document.getElementById('depositAmount').value = d.amount;
  document.getElementById('depositUsed').value = d.used || 0;
  populateClientSuggestions();
  document.getElementById('depositModal').style.display='flex';
}

function deleteDeposit(id){
  if(!hasPermission('canDeleteData')) { alert('You do not have permission to delete deposits'); return; }
  const dep = state.deposits.find(d=>d.id===id);
  if(dep && dep.saved) return alert('Cannot delete saved deposits');
  if(confirm('Delete deposit?')){
    state.deposits=state.deposits.filter(d=>d.id!==id);
    save();renderDeposits();renderRecords();
  }
}

function adminDeleteDeposit(id){
  const user = currentUser();
  if(!user || user.role !== 'admin') return alert('Admin only');
  if(confirm('Admin delete this saved deposit?')){
    state.deposits=state.deposits.filter(d=>d.id!==id);
    save();renderDeposits();renderRecords();
  }
}

function markDepositSaved(id){
  const dep = state.deposits.find(d => d.id === id);
  if(dep) {
    dep.saved = true;
    save();
    renderDeposits();
  }
}

function printDeposit(id){
  const d=state.deposits.find(d=>d.id===id);
  if(!d) return alert('Deposit not found');
  let html = companyHeaderHTML();
  html += `<h3 style="text-align:center">Customer Deposit Statement</h3>`;
  html += `<p><strong>Client:</strong> ${d.client}<br><strong>Date:</strong> ${d.date}</p>`;
  html += `<p><strong>Item/Service:</strong> ${d.item || 'N/A'}</p>`;
  html += `<table border="1" style="width:100%;border-collapse:collapse;">`;
  html += `<tr><th>Description</th><th>Amount</th></tr>`;
  html += `<tr><td>Deposit Amount</td><td>${fmt(d.amount)}</td></tr>`;
  html += `<tr><td>Amount Used</td><td>${fmt(d.used || 0)}</td></tr>`;
  html += `<tr><td><strong>Current Balance</strong></td><td><strong>${fmt(d.remainingBalance || (d.amount - (d.used || 0)))}</strong></td></tr>`;
  html += `</table>`;
  html += `<p style="margin-top:20px;"><em>This statement shows your current deposit balance. Please keep this for your records.</em></p>`;
  html += builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

function printDeposits(){
  const html=companyHeaderHTML()+'<h3>Deposits Report</h3>'+document.querySelector('#depositsTable').outerHTML + builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

/* ===========================
   RECORDS (with pagination + filters + tax invoice + prepaid sales)
   =========================== */
function buildRecordsArray(){
  const arr = [];
  // Sales
  state.sales.forEach(s=>{
    arr.push({
      type: 'Sale',
      date: s.date,
      ref: s.id,
      details: `Customer: ${s.customer}`,
      amount: s.total,
      meta: s.items ? s.items.map(i=>`${i.name} x${i.qty}`).join(', ') : 'No items'
    });
  });
  // Prepaid Sales
  state.prepaidSales.forEach(s=>{
    arr.push({
      type: 'Prepaid Sale',
      date: s.date,
      ref: s.id,
      details: `Customer: ${s.customer} (Prepaid)`,
      amount: s.total,
      meta: s.items ? s.items.map(i=>`${i.name} x${i.qty}`).join(', ') + ` | Used from balance: ${fmt(s.usedFromBalance)}` : 'No items'
    });
  });
  // Tax Invoices
  state.taxInvoices.forEach(t=>{
    arr.push({
      type: 'Tax Invoice',
      date: t.date,
      ref: t.id,
      details: `Invoice: ${t.invoiceNumber} - Customer: ${t.customer}`,
      amount: t.grandTotal,
      meta: `VAT: ${fmt(t.vatAmount)}, Items: ${t.items.length}`
    });
  });
  // Expenses
  state.expenses.forEach(e=>{
    arr.push({
      type: 'Expense',
      date: e.date,
      ref: e.id,
      details: `${e.category} - ${e.description}`,
      amount: Number(e.amount),
      meta: e.notes||''
    });
  });
  // Inventory
  state.inventory.forEach(i=>{
    arr.push({
      type: 'Inventory',
      date: i.created || new Date().toISOString().slice(0,10),
      ref: i.id,
      details: `${i.name} (${i.category||''})`,
      amount: i.qty,
      meta: `Cost: ${fmt(i.cost)} Supplier:${i.supplier||''}`
    });
  });
  // Deposits
  state.deposits.forEach(d=>{
    arr.push({
      type: 'Deposit',
      date: d.date,
      ref: d.id,
      details: `Client: ${d.client}, Item: ${d.item || 'N/A'}`,
      amount: d.amount,
      meta: `Used: ${fmt(d.used || 0)}, Balance: ${fmt(d.remainingBalance || (d.amount - (d.used || 0)))}`
    });
  });
  // Sort desc by date
  return arr.sort((a,b)=> a.date < b.date ? 1 : (a.date > b.date ? -1 : 0));
}

/* Pagination state */
let recordsPage = 1;
function renderRecords(list){
  if(!hasPermission('canViewRecords')) return;
  const tbody=document.querySelector('#recordsTable tbody'); tbody.innerHTML='';
  const rowsAll = list || buildRecordsArray();
  let rows = rowsAll;
  const typeFilter = document.getElementById('recordsType') ? document.getElementById('recordsType').value : '';
  const textFilter = document.getElementById('recordsText') ? document.getElementById('recordsText').value.toLowerCase() : '';
  if(typeFilter) rows = rows.filter(r=>r.type === typeFilter);
  if(textFilter) rows = rows.filter(r=> (r.details+' '+r.ref+' '+r.meta).toLowerCase().includes(textFilter));
  const from=document.getElementById('recordsFrom') ? document.getElementById('recordsFrom').value : '';
  const to=document.getElementById('recordsTo') ? document.getElementById('recordsTo').value : '';
  rows = rows.filter(r=> (!from || r.date >= from) && (!to || r.date <= to));

  const pageSize = Number(document.getElementById('recordsPageSize').value||10);
  const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
  if(recordsPage > totalPages) recordsPage = totalPages;
  const start = (recordsPage-1) * pageSize;
  const pageRows = rows.slice(start, start + pageSize);

  let totalMoney = 0;
  let totalQty = 0;
  pageRows.forEach(r=>{
    const tr=document.createElement('tr');
    let amountDisplay = '';
    if(r.type === 'Sale' || r.type === 'Prepaid Sale' || r.type === 'Expense' || r.type === 'Deposit' || r.type === 'Tax Invoice') {
      amountDisplay = fmt(r.amount);
      totalMoney += Number(r.amount||0);
    } else {
      amountDisplay = r.amount;
      totalQty += Number(r.amount||0);
    }
    tr.innerHTML = `<td>${r.type}</td><td>${r.date}</td><td>${r.ref}</td><td>${r.details}<div style="font-size:0.9em;color:#cbd5e1;margin-top:4px">${r.meta||''}</div></td><td>${amountDisplay}</td>
      <td>
        ${r.type === 'Sale' ? `<button class="btn btn-secondary small" onclick="printSale('${r.ref}', 'Regular')">üñ®Ô∏è</button>` : ''}
        ${r.type === 'Prepaid Sale' ? `<button class="btn btn-secondary small" onclick="printSale('${r.ref}', 'Prepaid')">üñ®Ô∏è</button>` : ''}
        ${r.type === 'Tax Invoice' ? `<button class="btn btn-secondary small" onclick="printTaxInvoice('${r.ref}')">üñ®Ô∏è</button>` : ''}
        ${r.type === 'Expense' ? `<button class="btn btn-secondary small" onclick="printExpense('${r.ref}')">üñ®Ô∏è</button>` : ''}
        ${r.type === 'Inventory' ? `<button class="btn btn-secondary small" onclick="printInventoryItem('${r.ref}')">üñ®Ô∏è</button>` : ''}
        ${r.type === 'Deposit' ? `<button class="btn btn-secondary small" onclick="printDeposit('${r.ref}')">üñ®Ô∏è</button>` : ''}
        ${currentUser() && currentUser().role === 'admin' ? `<button class="btn btn-danger small" onclick="adminDeleteRecord('${r.type}','${r.ref}')">Admin Delete</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
  const summary = `Total on page (money): ${fmt(totalMoney)} ‚Äî Total inventory qty on page: ${totalQty} ‚Äî Showing ${pageRows.length} of ${rows.length} records`;
  document.getElementById('recordsSummary').innerText = summary;
  document.getElementById('recordsPagerInfo').innerText = `Page ${recordsPage} / ${totalPages}`;
}

function searchRecords(){ recordsPage = 1; renderRecords(); }
function printRecords(){
  const html=companyHeaderHTML()+'<h3>Company Records (current page)</h3>'+document.querySelector('#recordsTable').outerHTML + builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

function adminDeleteRecord(type, ref){
  const user = currentUser();
  if(!user || user.role !== 'admin'){ alert('Admin access required'); return; }
  if(!confirm(`Admin delete this ${type}?`)) return;
 
  if(type === 'Sale') adminDeleteSale(ref, 'Regular');
  else if(type === 'Prepaid Sale') adminDeleteSale(ref, 'Prepaid');
  else if(type === 'Tax Invoice') adminDeleteTaxInvoice(ref);
  else if(type === 'Expense') adminDeleteExpense(ref);
  else if(type === 'Inventory') adminDeleteInventory(ref);
  else if(type === 'Deposit') adminDeleteDeposit(ref);
  renderAll();
}

/* helper prints */
function printExpense(id){
  const e = state.expenses.find(x=>x.id===id);
  if(!e) return alert('Expense not found');
  let html = companyHeaderHTML();
  html += `<h3>Expense Receipt</h3><p>${e.date}</p><p>${e.category} - ${e.description}</p><p>Amount: ${fmt(e.amount)}</p>`;
  html += builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

function printInventoryItem(id){
  const i=state.inventory.find(x=>x.id===id);
  if(!i) return alert('Item not found');
  let html = companyHeaderHTML();
  html += `<h3>Inventory Item</h3><p>${i.name}</p><p>Category: ${i.category||'N/A'}</p><p>Qty: ${i.qty}</p><p>Cost: ${fmt(i.cost)}</p>`;
  html += builderFooterHTML();
  const w=window.open(''); w.document.write(html); w.print();
}

/* pagination helpers */
function recordsNext(){ recordsPage++; renderRecords(); }
function recordsPrev(){ if(recordsPage>1) recordsPage--; renderRecords(); }
function recordsJump(){ const v = Number(document.getElementById('recordsGoto').value||1); recordsPage = Math.max(1, v); renderRecords(); }

/* ===========================
   USERS / SETTINGS (enhanced permissions)
   =========================== */
function openUserModal(){
  if(!hasPermission('canManageUsers')) { alert('You do not have permission to manage users'); return; }
  document.getElementById('userForm').reset();
  document.getElementById('userId').value='';
  populateUsersList();
  document.getElementById('userModal').style.display='flex';
}
function closeUserModal(){ document.getElementById('userModal').style.display='none'; }

function populateUsersList(){
  const el = document.getElementById('usersList'); el.innerHTML='';
  state.users.forEach(u=>{
    const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.padding='6px 0';
    const left = document.createElement('div'); left.innerHTML = `<strong>${u.username}</strong> <span class="muted">(${u.role})</span>`;
    const right = document.createElement('div');
    const edit = document.createElement('button'); edit.className='btn small'; edit.textContent='Edit'; edit.onclick=()=>{ editUser(u.id); };
    const del = document.createElement('button'); del.className='btn small'; del.textContent='Delete'; del.onclick=()=>{ if(confirm('Delete user?')){ state.users = state.users.filter(x=>x.id!==u.id); save(); populateUsersList(); } };
    right.appendChild(edit); right.appendChild(del);
    div.appendChild(left); div.appendChild(right);
    el.appendChild(div);
  });
}

function editUser(id){
  const u = state.users.find(x=>x.id===id); if(!u) return;
  document.getElementById('userId').value = u.id;
  document.getElementById('userName').value = u.username;
  document.getElementById('userPass').value = u.password;
  document.getElementById('userRole').value = u.role;
 
  // Set permission checkboxes
  const permissions = u.permissions || {};
  document.getElementById('userCanViewSales').checked = permissions.canViewSales !== false;
  document.getElementById('userCanViewInventory').checked = permissions.canViewInventory !== false;
  document.getElementById('userCanViewExpenses').checked = permissions.canViewExpenses !== false;
  document.getElementById('userCanViewEmployees').checked = !!permissions.canViewEmployees;
  document.getElementById('userCanViewSuppliers').checked = !!permissions.canViewSuppliers;
  document.getElementById('userCanViewDeposits').checked = !!permissions.canViewDeposits;
  document.getElementById('userCanViewTaxInvoice').checked = !!permissions.canViewTaxInvoice;
  document.getElementById('userCanViewRecords').checked = !!permissions.canViewRecords;
  document.getElementById('userCanViewSettings').checked = !!permissions.canViewSettings;
  document.getElementById('userCanCreateSales').checked = permissions.canCreateSales !== false;
  document.getElementById('userCanEditData').checked = !!permissions.canEditData;
  document.getElementById('userCanDeleteData').checked = !!permissions.canDeleteData;
  document.getElementById('userCanManageUsers').checked = !!permissions.canManageUsers;
  document.getElementById('userCanSaveSettings').checked = !!permissions.canSaveSettings;
 
  document.getElementById('userModal').style.display = 'flex';
}

document.getElementById('userForm').addEventListener('submit', e=>{
  e.preventDefault();
  if(!hasPermission('canSaveSettings')) { alert('You do not have permission to save user settings'); return; }
 
  const id = document.getElementById('userId').value || idf();
  const username = document.getElementById('userName').value.trim();
  const password = document.getElementById('userPass').value;
  const role = document.getElementById('userRole').value;
 
  // Get all permissions
  const permissions = {
    canViewSales: document.getElementById('userCanViewSales').checked,
    canViewInventory: document.getElementById('userCanViewInventory').checked,
    canViewExpenses: document.getElementById('userCanViewExpenses').checked,
    canViewEmployees: document.getElementById('userCanViewEmployees').checked,
    canViewSuppliers: document.getElementById('userCanViewSuppliers').checked,
    canViewDeposits: document.getElementById('userCanViewDeposits').checked,
    canViewTaxInvoice: document.getElementById('userCanViewTaxInvoice').checked,
    canViewRecords: document.getElementById('userCanViewRecords').checked,
    canViewSettings: document.getElementById('userCanViewSettings').checked,
    canCreateSales: document.getElementById('userCanCreateSales').checked,
    canEditData: document.getElementById('userCanEditData').checked,
    canDeleteData: document.getElementById('userCanDeleteData').checked,
    canManageUsers: document.getElementById('userCanManageUsers').checked,
    canSaveSettings: document.getElementById('userCanSaveSettings').checked
  };
 
  if(state.users.some(u=>u.username === username && u.id !== id)){ alert('Username already exists'); return; }
  const existingIndex = state.users.findIndex(u=>u.id===id);
  const userObj = {id, username, password, role, permissions};
  if(existingIndex >= 0) state.users[existingIndex] = userObj; else state.users.push(userObj);
  save(); populateUsersList(); closeUserModal();
  updateUIForAuth(); // Refresh UI to reflect permission changes
});

/* ===========================
   COMPANY & BUILDER SETTINGS
   =========================== */
document.getElementById('companyForm').addEventListener('submit', e=>{
  e.preventDefault();
  if(!hasPermission('canSaveSettings')) { alert('You do not have permission to save company settings'); return; }
 
  state.company = {
    name: document.getElementById('companyName').value,
    location: document.getElementById('companyLocation').value,
    box: document.getElementById('companyBox').value,
    tel: document.getElementById('companyTel').value,
    email: document.getElementById('companyEmail').value
  };
  save();
  alert('Company details saved successfully!');
});

document.getElementById('builderForm').addEventListener('submit', e=>{
  e.preventDefault();
  if(!hasPermission('canSaveSettings')) { alert('You do not have permission to save builder settings'); return; }
 
  state.builder = {
    name: document.getElementById('builderName').value,
    contact: document.getElementById('builderContact').value,
    website: document.getElementById('builderWebsite').value
  };
  save();
  alert('Builder details saved successfully!');
});

/* SETTINGS area render (Permission-based) */
function renderSettingsAdmin(){
  if(!hasPermission('canViewSettings')) return;
  const container = document.getElementById('settingsAdminArea'); container.innerHTML='';
  const user = currentUser();
 
  if(hasPermission('canManageUsers')){
    container.innerHTML += '<p>Configure system preferences here.</p>';
    const btn = document.createElement('button'); btn.className='btn btn-primary'; btn.textContent='Manage Users'; btn.onclick = openUserModal;
    container.appendChild(btn);
  } else {
    container.innerHTML += '<p class="muted">Contact administrator for user management access.</p>';
  }
 
  // Load company settings
  if(state.company){
    document.getElementById('companyName').value = state.company.name || '';
    document.getElementById('companyLocation').value = state.company.location || '';
    document.getElementById('companyBox').value = state.company.box || '';
    document.getElementById('companyTel').value = state.company.tel || '';
    document.getElementById('companyEmail').value = state.company.email || '';
  }
 
  // Load builder settings
  if(state.builder){
    document.getElementById('builderName').value = state.builder.name || '';
    document.getElementById('builderContact').value = state.builder.contact || '';
    document.getElementById('builderWebsite').value = state.builder.website || '';
  }
 
  // Disable save buttons if user doesn't have permission
  const saveCompanyBtn = document.getElementById('saveCompanyBtn');
  const saveBuilderBtn = document.getElementById('saveBuilderBtn');
  if(!hasPermission('canSaveSettings')) {
    saveCompanyBtn.disabled = true;
    saveBuilderBtn.disabled = true;
    saveCompanyBtn.textContent = 'No Permission';
    saveBuilderBtn.textContent = 'No Permission';
  } else {
    saveCompanyBtn.disabled = false;
    saveBuilderBtn.disabled = false;
    saveCompanyBtn.textContent = 'Save Company';
    saveBuilderBtn.textContent = 'Save Builder Info';
  }
}

/* ===========================
   AUTH UI updates & helpers
   =========================== */
function updateUIForAuth(){
  const user = currentUser();
  document.getElementById('currentUserDisplay').innerText = user ? `Signed in as: ${user.username} (${user.role})` : 'Not signed in';
  document.getElementById('systemStatus').innerText = user ? 'Online' : 'Offline';
 
  // Update nav items visibility and state based on permissions
  document.querySelectorAll("#navList .nav-item").forEach(nav=>{
    const view = nav.dataset.view;
    const permissionMap = {
      'dashboard': true, // Everyone can access dashboard
      'sales': 'canViewSales',
      'inventory': 'canViewInventory',
      'expenses': 'canViewExpenses',
      'employees': 'canViewEmployees',
      'suppliers': 'canViewSuppliers',
      'deposits': 'canViewDeposits',
      'tax-invoice': 'canViewTaxInvoice',
      'records': 'canViewRecords',
      'settings': 'canViewSettings'
    };
   
    const requiredPermission = permissionMap[view];
    if(requiredPermission === true || hasPermission(requiredPermission)) {
      nav.style.display = 'flex';
      nav.classList.remove('disabled');
    } else {
      nav.style.display = 'flex'; // Still show but disabled
      nav.classList.add('disabled');
    }
  });
 
  if(!user) showLogin(); else hideLogin();
  const qa = document.getElementById('quickUserActions'); qa.innerHTML='';
  if(user){
    const profileBtn = document.createElement('button'); profileBtn.className='btn small'; profileBtn.textContent='Profile';
    profileBtn.onclick = ()=>{
      const perms = user.permissions || {};
      const permList = Object.keys(perms).filter(k=>perms[k]).join(', ');
      alert(`Profile: ${user.username} (${user.role})\nPermissions: ${permList || 'None'}`);
    };
    qa.appendChild(profileBtn);
  }
}

/* ===========================
   RENDER ALL (initial)
   =========================== */
function renderAll(){
  renderSales();
  renderInventory();
  renderTaxInvoices();
  renderExpenses();
  renderEmployees();
  renderSuppliers();
  renderDeposits();
  renderRecords();
  renderSettingsAdmin();
  updateUIForAuth();
  updateDashboard();
}

// Initialize
renderAll();
updateLoginBranding();
if(!currentUser()) showLogin(); else hideLogin();
</script>
</body>
</html>
